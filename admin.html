<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - Express Delivery</title>
<style>
  :root{--brand:#1e90ff}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f6f8;color:#111}
  header{background:var(--brand);color:#fff;padding:14px 18px;}
  .container{max-width:1100px;margin:18px auto;padding:12px;}
  .box{background:white;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px}
  input,textarea,select,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;width:100%}
  label{display:block;margin-top:8px;font-weight:600}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .small{width:auto;padding:8px}
  .btn{background:var(--brand);color:#fff;border:none;padding:10px 12px;border-radius:6px;cursor:pointer}
  .btn.warn{background:#d9534f}
  .btn.gray{background:#6c757d}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border:1px solid #e6e6e6;text-align:left}
  th{background:var(--brand);color:white}
  .muted{color:#666;font-size:13px}
  @media(max-width:820px){.row{flex-direction:column}}
</style>
</head>
<body>
<header>
  <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
    <div><strong>Admin Dashboard</strong></div>
    <div style="font-size:0.95rem">Express Delivery Service</div>
  </div>
</header>

<div class="container">

  <!-- Login -->
  <div id="loginBox" class="box">
    <h3>Admin Login</h3>
    <label>Email</label>
    <input id="adminEmail" placeholder="admin email" autocomplete="username">
    <label>Password</label>
    <input id="adminPassword" type="password" placeholder="password" autocomplete="current-password">
    <div style="margin-top:10px;display:flex;gap:10px">
      <button class="btn" onclick="login()">Login</button>
      <button class="btn gray" onclick="fillDemoCredentials()">Fill demo creds</button>
    </div>
    <p id="loginMessage" class="muted"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">

    <!-- Shipments list -->
    <div class="box">
      <h3>Shipments</h3>
      <div class="muted">Create, edit, or delete shipments. Click <strong>Edit</strong> to load a shipment into the edit form below.</div>

      <table id="shipmentsTable">
        <thead>
          <tr>
            <th>Tracking</th><th>Content</th><th>Receiver</th><th>Amount</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="shipmentsTbody"></tbody>
      </table>
    </div>

    <!-- Create new shipment -->
    <div class="box">
      <h3>Create / Generate New Shipment</h3>
      <div class="row">
        <div class="col"><label>Content</label><input id="newContent" placeholder="e.g. Documents"></div>
        <div class="col"><label>Origin</label><input id="newOrigin" placeholder="Origin area"></div>
        <div class="col"><label>Destination</label><input id="newDestination" placeholder="Destination area"></div>
      </div>

      <div class="row">
        <div class="col"><label>Sender Name</label><input id="newSenderName" placeholder="Sender full name"></div>
        <div class="col"><label>Sender Address</label><input id="newSenderAddress" placeholder="Sender address"></div>
      </div>

      <div class="row">
        <div class="col"><label>Receiver Name</label><input id="newReceiverName" placeholder="Receiver full name"></div>
        <div class="col"><label>Receiver Address</label><input id="newReceiverAddress" placeholder="Receiver address"></div>
        <div class="col"><label>Receiver Mobile</label><input id="newReceiverMobile" placeholder="Receiver phone"></div>
      </div>

      <div class="row">
        <div class="col"><label>Receiver Latitude</label><input id="newReceiverLat" type="number" step="0.0001" placeholder="e.g. 59.9741"></div>
        <div class="col"><label>Receiver Longitude</label><input id="newReceiverLng" type="number" step="0.0001" placeholder="e.g. 30.3232"></div>
        <div class="col"><label>Receipt Amount</label><input id="newReceiptAmount" placeholder="e.g. 49.99"></div>
      </div>

      <label>Timeline (JSON array)</label>
      <textarea id="newTimeline" rows="4" placeholder='[{"time":"23 Sep 2025 07:30","description":"Item arrived","status":"ON HOLD","completed":true}]'></textarea>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="generateAndSave()">Generate Tracking & Save</button>
        <button class="btn gray" onclick="clearNewForm()">Clear</button>
      </div>
    </div>

    <!-- Edit shipment / receipt -->
    <div class="box">
      <h3>Edit Shipment / Receipt</h3>
      <div class="row" style="align-items:center">
        <div class="col">
          <label>Tracking number</label>
          <input id="editTracking" placeholder="Enter or select a tracking code from the table">
        </div>
        <div style="width:140px">
          <label>&nbsp;</label>
          <button class="btn" onclick="loadShipment()">Load</button>
        </div>
      </div>

      <div id="editArea" style="display:none;margin-top:12px">
        <label>Content</label>
        <input id="editContent">

        <div class="row">
          <div class="col"><label>Origin</label><input id="editOrigin"></div>
          <div class="col"><label>Destination</label><input id="editDestination"></div>
        </div>

        <h4 style="margin-top:10px">Sender</h4>
        <div class="row">
          <div class="col"><label>Name</label><input id="editSenderName"></div>
          <div class="col"><label>Address</label><input id="editSenderAddress"></div>
        </div>

        <h4 style="margin-top:10px">Receiver</h4>
        <div class="row">
          <div class="col"><label>Name</label><input id="editReceiverName"></div>
          <div class="col"><label>Address</label><input id="editReceiverAddress"></div>
          <div class="col"><label>Mobile</label><input id="editReceiverMobile"></div>
        </div>

        <div class="row">
          <div class="col"><label>Latitude</label><input id="editReceiverLat" type="number" step="0.0001"></div>
          <div class="col"><label>Longitude</label><input id="editReceiverLng" type="number" step="0.0001"></div>
          <div class="col"><label>Company (Receipt)</label><input id="editReceiptCompany"></div>
        </div>

        <div class="row">
          <div class="col"><label>Receipt Amount</label><input id="editReceiptAmount" placeholder="0.00"></div>
          <div class="col"><label>&nbsp;</label><div style="display:flex;gap:8px">
              <button class="btn" onclick="saveShipment()">Save Shipment</button>
              <button class="btn gray" onclick="deleteShipment()">Delete Shipment</button>
            </div>
          </div>
        </div>

        <label style="margin-top:8px">Timeline (JSON)</label>
        <textarea id="editTimeline" rows="5"></textarea>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" onclick="saveReceiptAndDownload()">Save Receipt & Download PDF</button>
          <button class="btn gray" onclick="downloadPDF(false)">Download PDF (no save)</button>
          <button class="btn gray" onclick="previewMap()">Preview Map</button>
        </div>

        <p id="editMessage" class="muted"></p>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px">
      <button class="btn warn" onclick="logout()">Logout</button>
      <div class="muted" style="align-self:center">Admin: <strong>Expressdeliveryservice0016@gmail.com</strong></div>
    </div>

  </div>
</div>

<!-- Hidden admin receipt template for PDF -->
<div id="adminReceiptTemplate" style="display:none;width:820px;padding:20px;font-family:Arial,Helvetica,sans-serif;background:#fff;border:1px solid #ddd;">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <img src="https://raw.githubusercontent.com/expressdeliveryservices/package-tracker/refs/heads/main/delivery-truck.png" alt="logo" style="height:44px">
      <img src="https://raw.githubusercontent.com/expressdeliveryservices/package-tracker/refs/heads/main/airplane.png" alt="logo2" style="height:44px;margin-left:8px">
    </div>
    <div id="adminTplCompany" style="font-weight:700;font-size:20px"></div>
  </div>
  <hr>
  <div style="margin-top:8px">
    <div><strong>Tracking Number:</strong> <span id="adminTplTracking"></span></div>
    <div><strong>Content:</strong> <span id="adminTplContent"></span></div>
    <div style="margin-top:8px"><strong>Sender:</strong> <span id="adminTplSender"></span></div>
    <div><strong>Receiver:</strong> <span id="adminTplReceiver"></span></div>
    <div style="margin-top:12px;font-weight:bold;font-size:16px">Amount: $<span id="adminTplAmount"></span></div>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------- Constants & helpers ---------------- */
const ADMIN_EMAIL = "Expressdeliveryservice0016@gmail.com";
const ADMIN_PW = "Umuojima";
const SHIP_KEY = 'shipments';

function uuidPart(n){ return Math.random().toString(36).substring(2,n+2).toUpperCase(); }
function generateTracking(){ // format ABC-123456789
  const letters = Array.from({length:3},()=>String.fromCharCode(65 + Math.floor(Math.random()*26))).join('');
  const numbers = Math.floor(100000000 + Math.random()*900000000).toString();
  return `${letters}-${numbers}`;
}

/* ---------------- Login / UI ---------------- */
function fillDemoCredentials(){
  document.getElementById('adminEmail').value = ADMIN_EMAIL;
  document.getElementById('adminPassword').value = ADMIN_PW;
}

function login(){
  const e = (document.getElementById('adminEmail').value||'').trim();
  const p = (document.getElementById('adminPassword').value||'').trim();
  if(e === ADMIN_EMAIL && p === ADMIN_PW){
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadShipmentsTable();
    document.getElementById('loginMessage').innerText = '';
  } else {
    document.getElementById('loginMessage').innerText = 'Invalid credentials';
  }
}

function logout(){
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginBox').style.display = 'block';
  document.getElementById('adminEmail').value = '';
  document.getElementById('adminPassword').value = '';
}

/* ---------------- Storage helpers ---------------- */
function readShipments(){ try { return JSON.parse(localStorage.getItem(SHIP_KEY) || '[]'); } catch(e){ return []; } }
function writeShipments(data){ localStorage.setItem(SHIP_KEY, JSON.stringify(data)); }

/* ---------------- Table & CRUD ---------------- */
function loadShipmentsTable(){
  const tbody = document.getElementById('shipmentsTbody');
  tbody.innerHTML = '';
  const shipments = readShipments();
  shipments.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="white-space:nowrap">${s.trackingNumber}</td>
      <td>${escapeHtml(s.content || '')}</td>
      <td>${escapeHtml(s.receiver?.name || '')}</td>
      <td>${escapeHtml(s.receipt?.amount || '0.00')}</td>
      <td style="white-space:nowrap">
        <button onclick="editFromRow('${s.trackingNumber}')" style="margin-right:6px">Edit</button>
        <button onclick="removeFromRow('${s.trackingNumber}')" style="background:#d9534f;color:#fff">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function editFromRow(code){
  document.getElementById('editTracking').value = code;
  loadShipment();
  window.scrollTo({top:0, behavior:'smooth'});
}

function removeFromRow(code){
  if(!confirm('Delete shipment ' + code + '?')) return;
  let shipments = readShipments();
  shipments = shipments.filter(s=>s.trackingNumber !== code);
  writeShipments(shipments);
  loadShipmentsTable();
  alert('Deleted');
}

/* ---------------- Create / Generate ---------------- */
function clearNewForm(){
  ['newContent','newOrigin','newDestination','newSenderName','newSenderAddress','newReceiverName','newReceiverAddress','newReceiverMobile','newReceiverLat','newReceiverLng','newReceiptAmount','newTimeline'].forEach(id=>document.getElementById(id).value='');
}

function generateAndSave(){
  try {
    const content = (document.getElementById('newContent').value||'').trim();
    const origin = (document.getElementById('newOrigin').value||'').trim();
    const destination = (document.getElementById('newDestination').value||'').trim();
    const senderName = (document.getElementById('newSenderName').value||'').trim();
    const senderAddress = (document.getElementById('newSenderAddress').value||'').trim();
    const receiverName = (document.getElementById('newReceiverName').value||'').trim();
    const receiverAddress = (document.getElementById('newReceiverAddress').value||'').trim();
    const receiverMobile = (document.getElementById('newReceiverMobile').value||'').trim();
    const lat = parseFloat(document.getElementById('newReceiverLat').value) || null;
    const lng = parseFloat(document.getElementById('newReceiverLng').value) || null;
    const amount = (document.getElementById('newReceiptAmount').value||'').trim() || '0.00';
    let timeline = [];
    try { timeline = JSON.parse((document.getElementById('newTimeline').value||'') || '[]'); } catch(e){ throw new Error('Timeline JSON invalid'); }

    if(!content || !origin || !destination) throw new Error('Fill content/origin/destination');

    const code = generateTracking();
    const shipment = {
      trackingNumber: code,
      content, origin, destination,
      sender: { name: senderName, address: senderAddress },
      receiver: { name: receiverName, address: receiverAddress, mobile: receiverMobile, lat, lng },
      timeline,
      receipt: { companyName: 'Express Delivery Service', amount }
    };

    const shipments = readShipments();
    shipments.push(shipment);
    writeShipments(shipments);
    loadShipmentsTable();
    clearNewForm();

    // load into edit area for quick edits
    document.getElementById('editTracking').value = code;
    loadShipment();
    alert('Shipment created with tracking: ' + code);
  } catch(err){
    alert('Error: ' + (err.message || err));
  }
}

/* ---------------- Load/edit/save/delete ---------------- */
function loadShipment(){
  const code = (document.getElementById('editTracking').value||'').trim();
  if(!code){ alert('Enter tracking number to load'); return; }
  const shipments = readShipments();
  const s = shipments.find(x=>x.trackingNumber === code);
  if(!s){ alert('Shipment not found'); return; }

  document.getElementById('editArea').style.display = 'block';
  document.getElementById('editContent').value = s.content || '';
  document.getElementById('editOrigin').value = s.origin || '';
  document.getElementById('editDestination').value = s.destination || '';
  document.getElementById('editSenderName').value = s.sender?.name || '';
  document.getElementById('editSenderAddress').value = s.sender?.address || '';
  document.getElementById('editReceiverName').value = s.receiver?.name || '';
  document.getElementById('editReceiverAddress').value = s.receiver?.address || '';
  document.getElementById('editReceiverMobile').value = s.receiver?.mobile || '';
  document.getElementById('editReceiverLat').value = s.receiver?.lat || '';
  document.getElementById('editReceiverLng').value = s.receiver?.lng || '';
  document.getElementById('editReceiptCompany').value = s.receipt?.companyName || 'Express Delivery Service';
  document.getElementById('editReceiptAmount').value = s.receipt?.amount || '0.00';
  try { document.getElementById('editTimeline').value = JSON.stringify(s.timeline || [], null, 2); } catch(e){ document.getElementById('editTimeline').value = '[]'; }
  document.getElementById('editMessage').innerText = '';
}

function saveShipment(){
  try {
    const code = (document.getElementById('editTracking').value||'').trim();
    if(!code) return alert('Enter tracking to save');

    const shipments = readShipments();
    const idx = shipments.findIndex(s=>s.trackingNumber === code);
    if(idx === -1) return alert('Shipment not found');

    shipments[idx].content = (document.getElementById('editContent').value||'').trim();
    shipments[idx].origin = (document.getElementById('editOrigin').value||'').trim();
    shipments[idx].destination = (document.getElementById('editDestination').value||'').trim();
    shipments[idx].sender = { name: (document.getElementById('editSenderName').value||'').trim(), address: (document.getElementById('editSenderAddress').value||'').trim() };
    shipments[idx].receiver = { name: (document.getElementById('editReceiverName').value||'').trim(), address: (document.getElementById('editReceiverAddress').value||'').trim(), mobile: (document.getElementById('editReceiverMobile').value||'').trim(), lat: parseFloat(document.getElementById('editReceiverLat').value) || null, lng: parseFloat(document.getElementById('editReceiverLng').value) || null };
    shipments[idx].receipt = { companyName: (document.getElementById('editReceiptCompany').value||'').trim(), amount: (document.getElementById('editReceiptAmount').value||'').trim() || '0.00' };
    shipments[idx].timeline = JSON.parse(document.getElementById('editTimeline').value || '[]');

    writeShipments(shipments);
    loadShipmentsTable();
    document.getElementById('editMessage').innerText = 'Saved successfully.';
  } catch(err){ alert('Save error: ' + (err.message || err)); }
}

function deleteShipment(){
  const code = (document.getElementById('editTracking').value||'').trim();
  if(!code) return alert('Enter tracking to delete');
  if(!confirm('Delete shipment ' + code + '?')) return;
  let shipments = readShipments();
  shipments = shipments.filter(s=>s.trackingNumber !== code);
  writeShipments(shipments);
  loadShipmentsTable();
  document.getElementById('editArea').style.display = 'none';
  alert('Deleted');
}

/* ---------------- PDF generation ---------------- */
async function populateAdminTemplate(shipment){
  document.getElementById('adminTplCompany').innerText = shipment.receipt?.companyName || 'Express Delivery Service';
  document.getElementById('adminTplTracking').innerText = shipment.trackingNumber;
  document.getElementById('adminTplContent').innerText = shipment.content || '';
  document.getElementById('adminTplSender').innerText = (shipment.sender?.name || '') + (shipment.sender?.address ? ' — ' + shipment.sender.address : '');
  document.getElementById('adminTplReceiver').innerText = (shipment.receiver?.name || '') + (shipment.receiver?.address ? ' — ' + shipment.receiver.address : '');
  document.getElementById('adminTplAmount').innerText = shipment.receipt?.amount || '0.00';
  return document.getElementById('adminReceiptTemplate');
}

async function downloadPDF(saveBeforeDownload = false){
  try {
    const code = (document.getElementById('editTracking').value||'').trim();
    if(!code) return alert('Enter tracking first');
    // optionally save current edits into storage first
    if(saveBeforeDownload) saveShipment();

    const shipments = readShipments();
    const s = shipments.find(x=>x.trackingNumber === code);
    if(!s) return alert('Shipment not found');

    const tpl = await populateAdminTemplate(s);
    tpl.style.display = 'block';
    tpl.style.background = '#fff';
    try {
      const canvas = await html2canvas(tpl, { scale: 2 });
      const img = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      // compute page size in px; use canvas width/height
      const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
      pdf.addImage(img, 'PNG', 0, 0, canvas.width, canvas.height);
      pdf.save(`Receipt-${s.trackingNumber}.pdf`);
    } catch(e){
      console.error(e);
      alert('PDF generation failed. Try printing the page as PDF.');
    } finally {
      tpl.style.display = 'none';
    }
  } catch(e){
    alert('Error: ' + (e.message || e));
  }
}

/* wrapper invoked by Save Receipt & Download */
async function saveReceiptAndDownload(){
  saveShipment(); // update storage
  await downloadPDF(false);
}

/* alias for quick call from UI */
function downloadAdminPDF(){ downloadPDF(false); }

/* ---------------- Utility: preview map by current lat/lng ---------------- */
function previewMap(){
  const lat = parseFloat(document.getElementById('editReceiverLat').value);
  const lng = parseFloat(document.getElementById('editReceiverLng').value);
  if(isNaN(lat) || isNaN(lng)) return alert('Enter valid lat & lng');
  const url = `https://www.google.com/maps?q=${lat},${lng}`;
  window.open(url, '_blank');
}

/* ---------------- Helpers & init ---------------- */
function escapeHtml(str){ if(!str) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* populate sample shipment on first load */
document.addEventListener('DOMContentLoaded', ()=>{
  try {
    let shipments = readShipments();
    if(!shipments.length){
      shipments.push({
        trackingNumber: 'ZWB-208345675',
        content: 'Package',
        origin: 'London UK',
        destination: 'St. Petersburg, Russia',
        sender: { name: 'James', address: 'London UK' },
        receiver: { name: 'Podvezennaya Elena Ivanovna', address: '195299 St. Petersburg, Prosveshcheniya Avenue 104, Apt. 281', mobile:'+79932195775', lat:59.9741, lng:30.3232 },
        timeline: [
          { time:'23 Sep 2025 07:30', description:'✅ Item has arrived at Vnukovo International Airport, Russia', status:'ON HOLD', completed:true },
          { time:'22 Sep 2025 14:00', description:'☑️ Your item is on its way from London, UK', status:'IN TRANSIT', completed:true }
        ],
        receipt: { companyName:'Express Delivery Service', amount:'49.99' }
      });
      writeShipments(shipments);
    }
  } catch(e){ console.error(e); }
});
</script>
</body>
</html>
