<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Express Delivery</title>

<!-- PWA Manifest -->
<link rel="manifest" href="/package-tracker/manifest.json">
<meta name="theme-color" content="#1e90ff">

<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; color: #000; margin: 0; padding: 0; }
header { background: #1e90ff; color: white; padding: 15px; text-align: center; }
.container { max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
input, textarea, select, button { margin: 5px 0; padding: 8px; width: 100%; border-radius: 3px; border: 1px solid #ccc; font-size: 14px; }
input[readonly] { background: #e0e0e0; cursor: not-allowed; }
button { background: #1e90ff; color: white; border: none; cursor: pointer; }
button:hover { background: #1565c0; }
h2, h3 { color: #1e90ff; margin-top: 0; }
.section { margin-bottom: 30px; }
label { font-weight: bold; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background: #1e90ff; color: white; }
.shipment-form div { margin-bottom: 10px; }
#generateTrackingCode { background: #4CAF50; color: white; }
#signaturePreview img { max-width: 100px; height: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 3px; }
#signaturePreview p { font-size: 12px; color: #555; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
</header>

<div class="container">

  <!-- Login Section -->
  <div class="section" id="loginSection">
    <h2>Login</h2>
    <label>Email:</label>
    <input type="email" id="adminEmail" placeholder="Enter admin email" required>
    <label>Password:</label>
    <input type="password" id="adminPassword" placeholder="Enter password" required>
    <button onclick="login()">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <!-- Dashboard Section -->
  <div class="section" id="dashboardSection" style="display:none;">

    <!-- Upload Signature -->
    <h2>Upload Signature Stamp</h2>
    <div class="section">
      <label>Signature Stamp Image:</label>
      <input type="file" id="signatureStamp" accept="image/*">
      <div id="signaturePreview"></div>
      <button onclick="saveSignatureStamp()">Save Signature Stamp</button>
    </div>

    <!-- Generate Tracking Code -->
    <h2>Generate New Tracking Code</h2>
    <div class="shipment-form">
      <input type="text" id="newTrackingNumber" placeholder="Tracking code will be generated" readonly>
      <div>
        <label>Amount ($):</label>
        <input type="number" id="newShipmentAmount" step="0.01" placeholder="Enter shipment amount" required>
      </div>
      <div>
        <label>Order ID:</label>
        <input type="text" id="newOrderId" placeholder="Enter order ID" required>
      </div>
      <div>
        <label>Est. Delivery Date:</label>
        <input type="date" id="newEstDeliveryDate" placeholder="Select estimated delivery date" required>
      </div>
      <div>
        <label>Payment Mode:</label>
        <input type="text" id="newPaymentMode" placeholder="Enter payment mode" required>
      </div>
      <div>
        <label>Mode of Transport:</label>
        <input type="text" id="newModeOfTransport" placeholder="Enter mode of transport" required>
      </div>
      <div>
        <label>Type of Shipment:</label>
        <input type="text" id="newTypeOfShipment" placeholder="Enter shipment type" required>
      </div>
      <div>
        <label>Quantity:</label>
        <input type="text" id="newQuantity" placeholder="Enter quantity" required>
      </div>
      <div>
        <label>Official Stamp Date:</label>
        <input type="date" id="newOfficialStampDate" placeholder="Select official stamp date" required>
      </div>
      <div>
        <label>Content:</label>
        <input type="text" id="newShipmentContent" placeholder="Enter shipment content" required>
      </div>
      <div>
        <label>Origin:</label>
        <input type="text" id="newShipmentOrigin" placeholder="Enter origin area" required>
      </div>
      <div>
        <label>Destination:</label>
        <input type="text" id="newShipmentDestination" placeholder="Enter destination area" required>
      </div>
      <h3>Sender Details</h3>
      <div>
        <label>Name:</label>
        <input type="text" id="newSenderName" placeholder="Enter sender name" required>
      </div>
      <div>
        <label>Address:</label>
        <input type="text" id="newSenderAddress" placeholder="Enter sender address" required>
      </div>
      <h3>Receiver Details</h3>
      <div>
        <label>Name:</label>
        <input type="text" id="newReceiverName" placeholder="Enter receiver name" required>
      </div>
      <div>
        <label>Address:</label>
        <input type="text" id="newReceiverAddress" placeholder="Enter receiver address" required>
      </div>
      <div>
        <label>Mobile:</label>
        <input type="text" id="newReceiverMobile" placeholder="Enter receiver mobile" required>
      </div>
      <div>
        <label>Latitude:</label>
        <input type="number" id="newReceiverLat" step="0.0001" placeholder="Enter receiver latitude" required>
      </div>
      <div>
        <label>Longitude:</label>
        <input type="number" id="newReceiverLng" step="0.0001" placeholder="Enter receiver longitude" required>
      </div>
      <h3>Timeline</h3>
      <textarea id="newTimeline" rows="4" placeholder='Enter timeline events as JSON array' required></textarea>
      <button id="generateTrackingCode" onclick="generateTrackingCode()">Generate Tracking Code</button>
      <p>Send the generated tracking code to the recipient for tracking on the public page.</p>
    </div>

    <!-- Edit Shipments -->
    <h2>Edit Shipments</h2>
    <div class="shipment-form">
      <label>Select Shipment:</label>
      <select id="shipmentSelect" onchange="loadShipment()">
        <option value="">Select a shipment</option>
      </select>
      <input type="text" id="trackingNumber" placeholder="Tracking Number" readonly>
      <div>
        <label>Amount ($):</label>
        <input type="number" id="shipmentAmount" step="0.01" placeholder="Enter shipment amount">
      </div>
      <!-- ... Keep all your existing input fields for editing shipments ... -->
      <button onclick="saveShipment()">Save Shipment</button>
    </div>

    <button style="background:red;margin-top:15px;" onclick="logout()">Logout</button>
  </div>

</div>

<script>
// === IndexedDB Helpers ===
function saveToIndexedDB(shipments) {
  const request = indexedDB.open("ExpressDB", 1);
  request.onupgradeneeded = e => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains("shipments")) {
      db.createObjectStore("shipments", { keyPath: "trackingNumber" });
    }
  };
  request.onsuccess = e => {
    const db = e.target.result;
    const tx = db.transaction("shipments", "readwrite");
    const store = tx.objectStore("shipments");
    shipments.forEach(s => store.put(s));
  };
}

function loadFromIndexedDB(callback) {
  const request = indexedDB.open("ExpressDB", 1);
  request.onupgradeneeded = e => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains("shipments")) {
      db.createObjectStore("shipments", { keyPath: "trackingNumber" });
    }
  };
  request.onsuccess = e => {
    const db = e.target.result;
    const tx = db.transaction("shipments", "readonly");
    const store = tx.objectStore("shipments");
    const getAll = store.getAll();
    getAll.onsuccess = () => callback(getAll.result || []);
  };
  request.onerror = e => {
    console.error("IndexedDB error:", e.target.error);
    callback([]);
  };
}

// === Admin Credentials ===
const ADMIN_EMAIL = "Expressdeliveryservice0016@gmail.com";
const ADMIN_PASSWORD = "Umuojima";
const COMPANY_NAME = "Express Delivery Service";

// === Login/Logout ===
function login() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value.trim();
  if (email === ADMIN_EMAIL && pass === ADMIN_PASSWORD) {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
    loadData();
  } else {
    document.getElementById('loginMessage').innerText = "Invalid email or password!";
  }
}

function logout() {
  document.getElementById('loginSection').style.display = 'block';
  document.getElementById('dashboardSection').style.display = 'none';
  document.getElementById('adminEmail').value = '';
  document.getElementById('adminPassword').value = '';
  document.getElementById('loginMessage').innerText = '';
}

// === Data Loading ===
function loadData() {
  let shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
  if (shipments.length === 0) {
    loadFromIndexedDB(restored => {
      if (restored.length > 0) {
        localStorage.setItem('shipments', JSON.stringify(restored));
        shipments = restored;
      }
      renderData(shipments);
    });
  } else {
    renderData(shipments);
  }
}

function renderData(shipments) {
  const shipmentSelect = document.getElementById('shipmentSelect');
  shipmentSelect.innerHTML = '<option value="">Select a shipment</option>';
  shipments.forEach(shipment => {
    const option = document.createElement('option');
    option.value = shipment.trackingNumber;
    option.text = `${shipment.trackingNumber} - ${shipment.content}`;
    shipmentSelect.appendChild(option);
  });

  const signatureStamp = localStorage.getItem('signatureStamp');
  const preview = document.getElementById('signaturePreview');
  if (signatureStamp) {
    preview.innerHTML = `<img src="${signatureStamp}" alt="Signature Stamp"><p>Current signature stamp</p>`;
  } else {
    preview.innerHTML = `<p>No signature stamp uploaded</p>`;
  }
}

// === Signature Stamp ===
function saveSignatureStamp() {
  const fileInput = document.getElementById('signatureStamp');
  const preview = document.getElementById('signaturePreview');
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    if (file.type.startsWith('image/') && file.size <= 2 * 1024 * 1024) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Image = e.target.result;
        localStorage.setItem('signatureStamp', base64Image);
        preview.innerHTML = `<img src="${base64Image}" alt="Signature Stamp"><p>Current signature stamp</p>`;
        alert("Signature stamp saved successfully!");
      };
      reader.readAsDataURL(file);
    } else {
      alert("Please upload a valid image file (max 2MB).");
    }
  } else {
    alert("Please select an image to upload.");
  }
}

// === Save & Generate Shipment ===
// Keep all your existing saveShipment() and generateTrackingCode() functions
// Keep loadShipment() function

</script>

<!-- Register Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/package-tracker/sw.js')
      .then(reg => console.log('Service Worker registered:', reg.scope))
      .catch(err => console.error('Service Worker registration failed:', err));
  });
}
</script>

</body>
</html>
