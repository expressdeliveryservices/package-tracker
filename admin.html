<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Admin Dashboard - Express Delivery</title>
  <link rel="manifest" href="admin-manifest.json">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/expressdeliveryservices/package-tracker/refs/heads/main/IMG_1855.jpeg">
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; color: #000; margin: 0; padding: 0; }
    header { background: #1e90ff; color: white; padding: 15px; text-align: center; }
    .container { max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, textarea, select, button { margin: 5px 0; padding: 8px; width: 100%; border-radius: 3px; border: 1px solid #ccc; font-size: 14px; }
    input[readonly] { background: #e0e0e0; cursor: not-allowed; }
    button { background: #1e90ff; color: white; border: none; cursor: pointer; }
    button:hover { background: #1565c0; }
    h2, h3 { color: #1e90ff; margin-top: 0; }
    .section { margin-bottom: 30px; }
    label { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #1e90ff; color: white; }
    .shipment-form div { margin-bottom: 10px; }
    #generateTrackingCode { background: #4CAF50; color: white; }
    #signaturePreview img { max-width: 100px; height: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 3px; }
    #signaturePreview p { font-size: 12px; color: #555; }
    #errorMessage { color: red; display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <noscript>JavaScript is required to use the Admin Dashboard. Please enable JavaScript in your browser.</noscript>
  <header>
    <h1>Admin Dashboard</h1>
  </header>

  <div class="container">
    <!-- Login Section -->
    <div class="section" id="loginSection">
      <h2>Login</h2>
      <label>Email:</label>
      <input type="email" id="adminEmail" placeholder="Enter admin email" required>
      <label>Password:</label>
      <input type="password" id="adminPassword" placeholder="Enter password" required>
      <button onclick="login()">Login</button>
      <p id="loginMessage" style="color:red;"></p>
    </div>

    <!-- Dashboard Section -->
    <div class="section" id="dashboardSection" style="display:none;">
      <h2>Upload Signature Stamp</h2>
      <div class="section">
        <label>Signature Stamp Image:</label>
        <input type="file" id="signatureStamp" accept="image/*">
        <div id="signaturePreview"></div>
        <button onclick="saveSignatureStamp()">Save Signature Stamp</button>
      </div>

      <h2>Generate New Tracking Code</h2>
      <div class="shipment-form">
        <input type="text" id="newTrackingNumber" placeholder="Tracking code will be generated" readonly>
        <div>
          <label>Amount ($):</label>
          <input type="number" id="newShipmentAmount" step="0.01" placeholder="Enter shipment amount" required>
        </div>
        <div>
          <label>Order ID:</label>
          <input type="text" id="newOrderId" placeholder="Enter order ID" required>
        </div>
        <div>
          <label>Est. Delivery Date:</label>
          <input type="date" id="newEstDeliveryDate" placeholder="Select estimated delivery date" required>
        </div>
        <div>
          <label>Payment Mode:</label>
          <input type="text" id="newPaymentMode" placeholder="Enter payment mode (e.g., Credit Card, Bank Transfer)" required>
        </div>
        <div>
          <label>Payment Method:</label>
          <input type="text" id="newPaymentMethod" placeholder="Enter payment method (e.g., Visa, PayPal)" required>
        </div>
        <div>
          <label>Mode of Transport:</label>
          <input type="text" id="newModeOfTransport" placeholder="Enter mode of transport (e.g., Air, Sea)" required>
        </div>
        <div>
          <label>Type of Shipment:</label>
          <input type="text" id="newTypeOfShipment" placeholder="Enter shipment type (e.g., Express, Standard)" required>
        </div>
        <div>
          <label>Quantity:</label>
          <input type="text" id="newQuantity" placeholder="Enter quantity (e.g., 2 boxes)" required>
        </div>
        <div>
          <label>Official Stamp Date:</label>
          <input type="date" id="newOfficialStampDate" placeholder="Select official stamp date" required>
        </div>
        <div>
          <label>Signed By:</label>
          <input type="text" id="newSignedBy" placeholder="Enter signed by name" required>
        </div>
        <div>
          <label>Content:</label>
          <input type="text" id="newShipmentContent" placeholder="Enter shipment content" required>
        </div>
        <div>
          <label>Origin:</label>
          <input type="text" id="newShipmentOrigin" placeholder="Enter origin area" required>
        </div>
        <div>
          <label>Destination:</label>
          <input type="text" id="newShipmentDestination" placeholder="Enter destination area" required>
        </div>
        <h3>Sender Details</h3>
        <div>
          <label>Name:</label>
          <input type="text" id="newSenderName" placeholder="Enter sender name" required>
        </div>
        <div>
          <label>Address:</label>
          <input type="text" id="newSenderAddress" placeholder="Enter sender address" required>
        </div>
        <h3>Receiver Details</h3>
        <div>
          <label>Name:</label>
          <input type="text" id="newReceiverName" placeholder="Enter receiver name" required>
        </div>
        <div>
          <label>Address:</label>
          <input type="text" id="newReceiverAddress" placeholder="Enter receiver address" required>
        </div>
        <div>
          <label>Mobile:</label>
          <input type="text" id="newReceiverMobile" placeholder="Enter receiver mobile" required>
        </div>
        <div>
          <label>Latitude:</label>
          <input type="number" id="newReceiverLat" step="0.0001" placeholder="Enter receiver latitude" required>
        </div>
        <div>
          <label>Longitude:</label>
          <input type="number" id="newReceiverLng" step="0.0001" placeholder="Enter receiver longitude" required>
        </div>
        <h3>Timeline</h3>
        <textarea id="newTimeline" rows="4" placeholder='Enter timeline events as JSON array (e.g., [{"time":"30 Sep 2025 02:00","description":"Item shipped","status":"SHIPPED","completed":true}])' required></textarea>
        <button id="generateTrackingCode" onclick="generateTrackingCode()">Generate Tracking Code</button>
        <p>Send the generated tracking code to the recipient for tracking on the public page.</p>
        <p id="errorMessage"></p>
      </div>

      <h2>Edit Shipments</h2>
      <div class="shipment-form">
        <label>Select Shipment:</label>
        <select id="shipmentSelect" onchange="loadShipment()">
          <option value="">Select a shipment</option>
        </select>
        <input type="text" id="trackingNumber" placeholder="Tracking Number" readonly>
        <div>
          <label>Amount ($):</label>
          <input type="number" id="shipmentAmount" step="0.01" placeholder="Enter shipment amount">
        </div>
        <div>
          <label>Order ID:</label>
          <input type="text" id="orderId" placeholder="Enter order ID">
        </div>
        <div>
          <label>Est. Delivery Date:</label>
          <input type="date" id="estDeliveryDate" placeholder="Select estimated delivery date">
        </div>
        <div>
          <label>Payment Mode:</label>
          <input type="text" id="paymentMode" placeholder="Enter payment mode (e.g., Credit Card, Bank Transfer)">
        </div>
        <div>
          <label>Payment Method:</label>
          <input type="text" id="paymentMethod" placeholder="Enter payment method (e.g., Visa, PayPal)">
        </div>
        <div>
          <label>Mode of Transport:</label>
          <input type="text" id="modeOfTransport" placeholder="Enter mode of transport">
        </div>
        <div>
          <label>Type of Shipment:</label>
          <input type="text" id="typeOfShipment" placeholder="Enter shipment type">
        </div>
        <div>
          <label>Quantity:</label>
          <input type="text" id="quantity" placeholder="Enter quantity">
        </div>
        <div>
          <label>Official Stamp Date:</label>
          <input type="date" id="officialStampDate" placeholder="Select official stamp date">
        </div>
        <div>
          <label>Signed By:</label>
          <input type="text" id="signedBy" placeholder="Enter signed by name">
        </div>
        <div>
          <label>Content:</label>
          <input type="text" id="shipmentContent" placeholder="Enter shipment content">
        </div>
        <div>
          <label>Origin:</label>
          <input type="text" id="shipmentOrigin" placeholder="Enter origin area">
        </div>
        <div>
          <label>Destination:</label>
          <input type="text" id="shipmentDestination" placeholder="Enter destination area">
        </div>
        <h3>Sender Details</h3>
        <div>
          <label>Name:</label>
          <input type="text" id="senderName" placeholder="Enter sender name">
        </div>
        <div>
          <label>Address:</label>
          <input type="text" id="senderAddress" placeholder="Enter sender address">
        </div>
        <h3>Receiver Details</h3>
        <div>
          <label>Name:</label>
          <input type="text" id="receiverName" placeholder="Enter receiver name">
        </div>
        <div>
          <label>Address:</label>
          <input type="text" id="receiverAddress" placeholder="Enter receiver address">
        </div>
        <div>
          <label>Mobile:</label>
          <input type="text" id="receiverMobile" placeholder="Enter receiver mobile">
        </div>
        <div>
          <label>Latitude:</label>
          <input type="number" id="receiverLat" step="0.0001" placeholder="Enter receiver latitude">
        </div>
        <div>
          <label>Longitude:</label>
          <input type="number" id="receiverLng" step="0.0001" placeholder="Enter receiver longitude">
        </div>
        <h3>Timeline</h3>
        <textarea id="timeline" rows="4" placeholder='Enter timeline events as JSON array (e.g., [{"time":"30 Sep 2025 02:00","description":"Item shipped","status":"SHIPPED","completed":true}])'></textarea>
        <button onclick="saveShipment()">Save Shipment</button>
        <p id="errorMessage"></p>
      </div>

      <button style="background:red;margin-top:15px;" onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    const DB_NAME = "ExpressDeliveryDB";
    const DB_VERSION = 2; // Incremented to force database reset if corrupted
    const SHIPMENTS_STORE = "shipments";
    const SETTINGS_STORE = "settings";
    const ADMIN_EMAIL = "Expressdeliveryservice0016@gmail.com";
    const ADMIN_PASSWORD = "Umuojima";
    const COMPANY_NAME = "Express Delivery Service";

    let db;

    async function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          console.log("Upgrading IndexedDB to version", DB_VERSION);
          // Clear existing stores to prevent corruption
          if (db.objectStoreNames.contains(SHIPMENTS_STORE)) {
            db.deleteObjectStore(SHIPMENTS_STORE);
          }
          if (db.objectStoreNames.contains(SETTINGS_STORE)) {
            db.deleteObjectStore(SETTINGS_STORE);
          }
          db.createObjectStore(SHIPMENTS_STORE, { keyPath: "trackingNumber" });
          db.createObjectStore(SETTINGS_STORE, { keyPath: "key" });
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          console.log("IndexedDB opened successfully");
          resolve(db);
        };
        request.onerror = (event) => {
          console.error("IndexedDB open failed:", event.target.error);
          document.getElementById("errorMessage").textContent = `Failed to open database: ${event.target.error.message}. Please refresh.`;
          document.getElementById("errorMessage").style.display = "block";
          reject(event.target.error);
        };
      });
    }

    async function requestPersistentStorage() {
      if (navigator.storage && navigator.storage.persist) {
        const isPersisted = await navigator.storage.persisted();
        if (!isPersisted) {
          const result = await navigator.storage.persist();
          console.log("Persistent storage granted:", result);
        } else {
          console.log("Storage is already persistent");
        }
      } else {
        console.warn("Storage API not supported");
      }
    }

    async function migrateLocalStorageToIndexedDB() {
      const shipments = JSON.parse(localStorage.getItem("shipments") || "[]");
      const newsletter = localStorage.getItem("newsletterEmails") || "";
      const signatureStamp = localStorage.getItem("signatureStamp") || "";
      if (shipments.length > 0 || newsletter || signatureStamp) {
        const tx = db.transaction([SHIPMENTS_STORE, SETTINGS_STORE], "readwrite");
        const shipmentStore = tx.objectStore(SHIPMENTS_STORE);
        const settingsStore = tx.objectStore(SETTINGS_STORE);

        shipments.forEach((shipment) => {
          shipmentStore.put(shipment);
        });
        if (newsletter) settingsStore.put({ key: "newsletterEmails", value: newsletter });
        if (signatureStamp) settingsStore.put({ key: "signatureStamp", value: signatureStamp });

        await new Promise((resolve, reject) => {
          tx.oncomplete = () => {
            console.log("Migration to IndexedDB completed");
            localStorage.removeItem("shipments");
            localStorage.removeItem("newsletterEmails");
            localStorage.removeItem("signatureStamp");
            resolve();
          };
          tx.onerror = () => {
            console.error("Migration error:", tx.error);
            document.getElementById("errorMessage").textContent = `Migration error: ${tx.error.message}`;
            document.getElementById("errorMessage").style.display = "block";
            reject(tx.error);
          };
        });
      }
    }

    function login() {
      const email = document.getElementById("adminEmail").value.trim();
      const pass = document.getElementById("adminPassword").value.trim();
      if (email === ADMIN_EMAIL && pass === ADMIN_PASSWORD) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("dashboardSection").style.display = "block";
        document.getElementById("loginMessage").innerText = "";
        loadData();
      } else {
        document.getElementById("loginMessage").innerText = "Invalid email or password!";
      }
    }

    function logout() {
      document.getElementById("loginSection").style.display = "block";
      document.getElementById("dashboardSection").style.display = "none";
      document.getElementById("adminEmail").value = "";
      document.getElementById("adminPassword").value = "";
      document.getElementById("loginMessage").innerText = "";
    }

    async function loadData() {
      try {
        if (!db) {
          throw new Error("Database not initialized. Please refresh the page.");
        }
        const tx = db.transaction([SHIPMENTS_STORE, SETTINGS_STORE], "readonly");
        const shipmentStore = tx.objectStore(SHIPMENTS_STORE);
        const settingsStore = tx.objectStore(SETTINGS_STORE);

        // Load shipments
        const shipmentRequest = shipmentStore.getAll();
        shipmentRequest.onsuccess = () => {
          const shipments = shipmentRequest.result;
          const shipmentSelect = document.getElementById("shipmentSelect");
          shipmentSelect.innerHTML = '<option value="">Select a shipment</option>';
          shipments.forEach((shipment) => {
            const option = document.createElement("option");
            option.value = shipment.trackingNumber;
            option.text = `${shipment.trackingNumber} - ${shipment.content || "No content"}`;
            shipmentSelect.appendChild(option);
          });
          console.log("Shipments loaded:", shipments.length);
        };
        shipmentRequest.onerror = () => {
          console.error("Error loading shipments:", shipmentRequest.error);
          document.getElementById("errorMessage").textContent = `Error loading shipments: ${shipmentRequest.error.message}`;
          document.getElementById("errorMessage").style.display = "block";
        };

        // Load signature stamp
        const signatureRequest = settingsStore.get("signatureStamp");
        signatureRequest.onsuccess = () => {
          const signatureStamp = signatureRequest.result ? signatureRequest.result.value : "";
          const preview = document.getElementById("signaturePreview");
          if (signatureStamp) {
            preview.innerHTML = `<img src="${signatureStamp}" alt="Signature Stamp"><p>Current signature stamp</p>`;
          } else {
            preview.innerHTML = `<p>No signature stamp uploaded</p>`;
          }
          console.log("Signature stamp loaded");
        };
        signatureRequest.onerror = () => {
          console.error("Error loading signature stamp:", signatureRequest.error);
          document.getElementById("signaturePreview").innerHTML = `<p>Error loading signature stamp: ${signatureRequest.error.message}</p>`;
        };

        await new Promise((resolve, reject) => {
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      } catch (e) {
        console.error("Load data error:", e.message);
        document.getElementById("errorMessage").textContent = `Error loading data: ${e.message}. Please refresh or clear browser data.`;
        document.getElementById("errorMessage").style.display = "block";
      }
    }

    async function saveSignatureStamp() {
      const fileInput = document.getElementById("signatureStamp");
      const preview = document.getElementById("signaturePreview");
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        if (file.type.startsWith("image/") && file.size <= 2 * 1024 * 1024) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const base64Image = e.target.result;
              const tx = db.transaction([SETTINGS_STORE], "readwrite");
              const store = tx.objectStore(SETTINGS_STORE);
              store.put({ key: "signatureStamp", value: base64Image });
              await new Promise((resolve, reject) => {
                tx.oncomplete = () => {
                  preview.innerHTML = `<img src="${base64Image}" alt="Signature Stamp"><p>Current signature stamp</p>`;
                  alert("Signature stamp saved successfully!");
                  resolve();
                };
                tx.onerror = () => {
                  console.error("Error saving signature stamp:", tx.error);
                  alert(`Error saving signature stamp: ${tx.error.message}`);
                  reject(tx.error);
                };
              });
            } catch (e) {
              console.error("Signature save error:", e);
              alert(`Error saving signature stamp: ${e.message}`);
            }
          };
          reader.readAsDataURL(file);
        } else {
          alert("Please upload a valid image file (max 2MB).");
        }
      } else {
        alert("Please select an image to upload.");
      }
    }

    async function generateTrackingCode() {
      try {
        // Generate unique tracking number
        let newTracking;
        let isUnique = false;
        const txCheck = db.transaction([SHIPMENTS_STORE], "readonly");
        const storeCheck = txCheck.objectStore(SHIPMENTS_STORE);
        while (!isUnique) {
          const letters = String.fromCharCode(...Array(3).fill().map(() => 65 + Math.floor(Math.random() * 26)));
          const numbers = Math.floor(100000000 + Math.random() * 900000000).toString();
          newTracking = `${letters}-${numbers}`;
          const request = storeCheck.get(newTracking);
          await new Promise((resolve) => {
            request.onsuccess = () => {
              isUnique = !request.result;
              resolve();
            };
            request.onerror = () => {
              console.error("Error checking tracking number:", request.error);
              resolve();
            };
          });
        }

        const shipment = {
          trackingNumber: newTracking,
          content: document.getElementById("newShipmentContent").value.trim(),
          origin: document.getElementById("newShipmentOrigin").value.trim(),
          destination: document.getElementById("newShipmentDestination").value.trim(),
          orderId: document.getElementById("newOrderId").value.trim(),
          estDeliveryDate: document.getElementById("newEstDeliveryDate").value.trim(),
          modeOfTransport: document.getElementById("newModeOfTransport").value.trim(),
          typeOfShipment: document.getElementById("newTypeOfShipment").value.trim(),
          quantity: document.getElementById("newQuantity").value.trim(),
          paymentMode: document.getElementById("newPaymentMode").value.trim(),
          paymentMethod: document.getElementById("newPaymentMethod").value.trim(),
          officialStampDate: document.getElementById("newOfficialStampDate").value.trim(),
          signedBy: document.getElementById("newSignedBy").value.trim(),
          officialStamp: (await getSignatureStamp()) || "",
          sender: {
            name: document.getElementById("newSenderName").value.trim(),
            address: document.getElementById("newSenderAddress").value.trim(),
          },
          receiver: {
            name: document.getElementById("newReceiverName").value.trim(),
            address: document.getElementById("newReceiverAddress").value.trim(),
            mobile: document.getElementById("newReceiverMobile").value.trim(),
            lat: parseFloat(document.getElementById("newReceiverLat").value),
            lng: parseFloat(document.getElementById("newReceiverLng").value),
          },
          timeline: JSON.parse(document.getElementById("newTimeline").value.trim() || "[]"),
          receipt: {
            companyName: COMPANY_NAME,
            amount: parseFloat(document.getElementById("newShipmentAmount").value),
          },
        };

        // Validate required fields
        if (!shipment.content || !shipment.origin || !shipment.destination || !shipment.sender.name ||
            !shipment.sender.address || !shipment.receiver.name || !shipment.receiver.address ||
            !shipment.receiver.mobile || isNaN(shipment.receiver.lat) || isNaN(shipment.receiver.lng) ||
            !shipment.orderId || !shipment.estDeliveryDate || !shipment.modeOfTransport ||
            !shipment.typeOfShipment || !shipment.quantity || !shipment.officialStampDate ||
            !shipment.paymentMode || !shipment.paymentMethod || !shipment.signedBy ||
            isNaN(shipment.receipt.amount)) {
          throw new Error("All fields are required and must be valid.");
        }

        const tx = db.transaction([SHIPMENTS_STORE], "readwrite");
        const store = tx.objectStore(SHIPMENTS_STORE);
        store.put(shipment);
        await new Promise((resolve, reject) => {
          tx.oncomplete = () => {
            // Load into edit form
            document.getElementById("trackingNumber").value = shipment.trackingNumber;
            document.getElementById("shipmentAmount").value = shipment.receipt.amount;
            document.getElementById("orderId").value = shipment.orderId;
            document.getElementById("estDeliveryDate").value = shipment.estDeliveryDate;
            document.getElementById("modeOfTransport").value = shipment.modeOfTransport;
            document.getElementById("typeOfShipment").value = shipment.typeOfShipment;
            document.getElementById("quantity").value = shipment.quantity;
            document.getElementById("officialStampDate").value = shipment.officialStampDate;
            document.getElementById("paymentMode").value = shipment.paymentMode;
            document.getElementById("paymentMethod").value = shipment.paymentMethod;
            document.getElementById("signedBy").value = shipment.signedBy;
            document.getElementById("shipmentContent").value = shipment.content;
            document.getElementById("shipmentOrigin").value = shipment.origin;
            document.getElementById("shipmentDestination").value = shipment.destination;
            document.getElementById("senderName").value = shipment.sender.name;
            document.getElementById("senderAddress").value = shipment.sender.address;
            document.getElementById("receiverName").value = shipment.receiver.name;
            document.getElementById("receiverAddress").value = shipment.receiver.address;
            document.getElementById("receiverMobile").value = shipment.receiver.mobile;
            document.getElementById("receiverLat").value = shipment.receiver.lat;
            document.getElementById("receiverLng").value = shipment.receiver.lng;
            document.getElementById("timeline").value = JSON.stringify(shipment.timeline, null, 2);
            document.getElementById("newTrackingNumber").value = newTracking;

            alert(`New tracking code generated: ${newTracking}. Details saved and loaded for editing. Changes will reflect on the public page.`);
            loadData();
            resolve();
          };
          tx.onerror = () => {
            console.error("Error saving shipment:", tx.error);
            alert(`Error saving shipment: ${tx.error.message}`);
            reject(tx.error);
          };
        });
      } catch (e) {
        console.error("Generate tracking code error:", e);
        document.getElementById("errorMessage").textContent = `Error: ${e.message}`;
        document.getElementById("errorMessage").style.display = "block";
      }
    }

    async function saveShipment() {
      try {
        const trackingNumber = document.getElementById("trackingNumber").value.trim();
        if (!trackingNumber) {
          throw new Error("Please select a shipment to edit.");
        }
        const shipment = {
          trackingNumber: trackingNumber,
          content: document.getElementById("shipmentContent").value.trim(),
          origin: document.getElementById("shipmentOrigin").value.trim(),
          destination: document.getElementById("shipmentDestination").value.trim(),
          orderId: document.getElementById("orderId").value.trim(),
          estDeliveryDate: document.getElementById("estDeliveryDate").value.trim(),
          modeOfTransport: document.getElementById("modeOfTransport").value.trim(),
          typeOfShipment: document.getElementById("typeOfShipment").value.trim(),
          quantity: document.getElementById("quantity").value.trim(),
          paymentMode: document.getElementById("paymentMode").value.trim(),
          paymentMethod: document.getElementById("paymentMethod").value.trim(),
          officialStampDate: document.getElementById("officialStampDate").value.trim(),
          signedBy: document.getElementById("signedBy").value.trim(),
          officialStamp: (await getSignatureStamp()) || "",
          sender: {
            name: document.getElementById("senderName").value.trim(),
            address: document.getElementById("senderAddress").value.trim(),
          },
          receiver: {
            name: document.getElementById("receiverName").value.trim(),
            address: document.getElementById("receiverAddress").value.trim(),
            mobile: document.getElementById("receiverMobile").value.trim(),
            lat: parseFloat(document.getElementById("receiverLat").value),
            lng: parseFloat(document.getElementById("receiverLng").value),
          },
          timeline: JSON.parse(document.getElementById("timeline").value.trim() || "[]"),
          receipt: {
            companyName: COMPANY_NAME,
            amount: parseFloat(document.getElementById("shipmentAmount").value),
          },
        };

        // Validate required fields
        if (!shipment.content || !shipment.origin || !shipment.destination || !shipment.sender.name ||
            !shipment.sender.address || !shipment.receiver.name || !shipment.receiver.address ||
            !shipment.receiver.mobile || isNaN(shipment.receiver.lat) || isNaN(shipment.receiver.lng) ||
            !shipment.orderId || !shipment.estDeliveryDate || !shipment.modeOfTransport ||
            !shipment.typeOfShipment || !shipment.quantity || !shipment.officialStampDate ||
            !shipment.paymentMode || !shipment.paymentMethod || !shipment.signedBy ||
            isNaN(shipment.receipt.amount)) {
          throw new Error("All fields are required and must be valid.");
        }

        const tx = db.transaction([SHIPMENTS_STORE], "readwrite");
        const store = tx.objectStore(SHIPMENTS_STORE);
        store.put(shipment);
        await new Promise((resolve, reject) => {
          tx.oncomplete = () => {
            alert("Shipment saved successfully! Changes will reflect on the public page.");
            loadData();
            resolve();
          };
          tx.onerror = () => {
            console.error("Error saving shipment:", tx.error);
            alert(`Error saving shipment: ${tx.error.message}`);
            reject(tx.error);
          };
        });
      } catch (e) {
        console.error("Save shipment error:", e);
        document.getElementById("errorMessage").textContent = `Error: ${e.message}`;
        document.getElementById("errorMessage").style.display = "block";
      }
    }

    async function loadShipment() {
      const trackingNumber = document.getElementById("shipmentSelect").value;
      const errorMessage = document.getElementById("errorMessage");
      errorMessage.style.display = "none";
      if (!trackingNumber) {
        // Clear form
        document.getElementById("trackingNumber").value = "";
        document.getElementById("shipmentAmount").value = "";
        document.getElementById("orderId").value = "";
        document.getElementById("estDeliveryDate").value = "";
        document.getElementById("modeOfTransport").value = "";
        document.getElementById("typeOfShipment").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("officialStampDate").value = "";
        document.getElementById("paymentMode").value = "";
        document.getElementById("paymentMethod").value = "";
        document.getElementById("signedBy").value = "";
        document.getElementById("shipmentContent").value = "";
        document.getElementById("shipmentOrigin").value = "";
        document.getElementById("shipmentDestination").value = "";
        document.getElementById("senderName").value = "";
        document.getElementById("senderAddress").value = "";
        document.getElementById("receiverName").value = "";
        document.getElementById("receiverAddress").value = "";
        document.getElementById("receiverMobile").value = "";
        document.getElementById("receiverLat").value = "";
        document.getElementById("receiverLng").value = "";
        document.getElementById("timeline").value = "";
        return;
      }

      try {
        const tx = db.transaction([SHIPMENTS_STORE], "readonly");
        const store = tx.objectStore(SHIPMENTS_STORE);
        const request = store.get(trackingNumber);
        request.onsuccess = () => {
          const shipment = request.result;
          if (shipment) {
            document.getElementById("trackingNumber").value = shipment.trackingNumber;
            document.getElementById("shipmentAmount").value = shipment.receipt.amount;
            document.getElementById("orderId").value = shipment.orderId;
            document.getElementById("estDeliveryDate").value = shipment.estDeliveryDate;
            document.getElementById("modeOfTransport").value = shipment.modeOfTransport;
            document.getElementById("typeOfShipment").value = shipment.typeOfShipment;
            document.getElementById("quantity").value = shipment.quantity;
            document.getElementById("officialStampDate").value = shipment.officialStampDate;
            document.getElementById("paymentMode").value = shipment.paymentMode;
            document.getElementById("paymentMethod").value = shipment.paymentMethod || "";
            document.getElementById("signedBy").value = shipment.signedBy || "";
            document.getElementById("shipmentContent").value = shipment.content;
            document.getElementById("shipmentOrigin").value = shipment.origin;
            document.getElementById("shipmentDestination").value = shipment.destination;
            document.getElementById("senderName").value = shipment.sender.name;
            document.getElementById("senderAddress").value = shipment.sender.address;
            document.getElementById("receiverName").value = shipment.receiver.name;
            document.getElementById("receiverAddress").value = shipment.receiver.address;
            document.getElementById("receiverMobile").value = shipment.receiver.mobile;
            document.getElementById("receiverLat").value = shipment.receiver.lat;
            document.getElementById("receiverLng").value = shipment.receiver.lng;
            document.getElementById("timeline").value = JSON.stringify(shipment.timeline, null, 2);
          } else {
            document.getElementById("errorMessage").textContent = "Shipment not found.";
            document.getElementById("errorMessage").style.display = "block";
          }
        };
        request.onerror = () => {
          console.error("Error loading shipment:", request.error);
          document.getElementById("errorMessage").textContent = `Error loading shipment: ${request.error.message}`;
          document.getElementById("errorMessage").style.display = "block";
        };
      } catch (e) {
        console.error("Load shipment error:", e);
        document.getElementById("errorMessage").textContent = `Error loading shipment: ${e.message}`;
        document.getElementById("errorMessage").style.display = "block";
      }
    }

    async function getSignatureStamp() {
      return new Promise((resolve) => {
        const tx = db.transaction([SETTINGS_STORE], "readonly");
        const store = tx.objectStore(SETTINGS_STORE);
        const request = store.get("signatureStamp");
        request.onsuccess = () => resolve(request.result ? request.result.value : "");
        request.onerror = () => {
          console.error("Error retrieving signature stamp:", request.error);
          resolve("");
        };
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await initIndexedDB();
        await requestPersistentStorage();
        await migrateLocalStorageToIndexedDB();
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("sw.js").then((reg) => {
            console.log("Service worker registered:", reg.scope);
            if (reg.installing) {
              console.log("Service worker installing");
            } else if (reg.waiting) {
              console.log("Service worker installed, waiting");
            } else if (reg.active) {
              console.log("Service worker active");
            }
          }).catch((err) => {
            console.error("Service worker registration failed:", err.message);
            document.getElementById("errorMessage").textContent = `Offline support may be limited: ${err.message}`;
            document.getElementById("errorMessage").style.display = "block";
          });
        } else {
          console.warn("Service workers not supported");
          document.getElementById("errorMessage").textContent = "Offline support not available in this browser.";
          document.getElementById("errorMessage").style.display = "block";
        }
      } catch (e) {
        console.error("Initialization error:", e.message);
        document.getElementById("errorMessage").textContent = `Error initializing dashboard: ${e.message}. Please refresh or clear browser data.`;
        document.getElementById("errorMessage").style.display = "block";
      }
    });
  </script>
</body>
</html>
