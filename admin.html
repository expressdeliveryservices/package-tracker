<!-- admin.html (replace <script> section) -->
<script>
  const API_BASE_URL = 'https://your-render-app.onrender.com/api'; // Update after deployment
  const ADMIN_EMAIL = 'Expressdeliveryservice0016@gmail.com';
  const ADMIN_PASSWORD = 'Umuojima';
  const COMPANY_NAME = 'Express Delivery Service';

  function setupImagePreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    input.addEventListener('change', () => {
      const file = input.files[0];
      if (!file) {
        preview.innerHTML = '<p>No stamp image selected.</p>';
        return;
      }
      if (!file.type.startsWith('image/')) {
        alert('Please upload a valid image file.');
        input.value = '';
        preview.innerHTML = '<p>No stamp image selected.</p>';
        return;
      }
      if (file.size > 2 * 1024 * 1024) {
        alert('Image size must be less than 2MB.');
        input.value = '';
        preview.innerHTML = '<p>No stamp image selected.</p>';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        preview.innerHTML = `<img src="${reader.result}" alt="Stamp Preview"><p>Image selected: ${file.name}</p>`;
      };
      reader.onerror = () => {
        alert('Error reading image file.');
        preview.innerHTML = '<p>No stamp image selected.</p>';
      };
      reader.readAsDataURL(file);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupImagePreview('newOfficialStamp', 'newSignaturePreview');
    setupImagePreview('officialStamp', 'signaturePreview');
    loadData();
  });

  async function login() {
    const email = document.getElementById('adminEmail').value.trim();
    const pass = document.getElementById('adminPassword').value.trim();
    if (email === ADMIN_EMAIL && pass === ADMIN_PASSWORD) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      await loadData();
    } else {
      document.getElementById('loginMessage').innerText = 'Invalid email or password!';
    }
  }

  function logout() {
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('dashboardSection').style.display = 'none';
    document.getElementById('adminEmail').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('loginMessage').innerText = '';
  }

  async function loadData() {
    try {
      // Load shipments
      const shipmentResponse = await fetch(`${API_BASE_URL}/shipments`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
      });
      const shipments = await shipmentResponse.json();
      const shipmentSelect = document.getElementById('shipmentSelect');
      shipmentSelect.innerHTML = '<option value="">Select a shipment</option>';
      shipments.forEach(shipment => {
        const option = document.createElement('option');
        option.value = shipment.trackingNumber;
        option.text = `${shipment.trackingNumber} - ${shipment.content}`;
        shipmentSelect.appendChild(option);
      });

      // Load newsletter emails (from localStorage for now)
      const newsletter = localStorage.getItem('newsletterEmails') || '';
      document.getElementById('newsletterList').value = newsletter.split(',').filter(Boolean).join('\n');

      // Load reviews (from localStorage for now)
      const reviews = localStorage.getItem('customerReviews') || '';
      document.getElementById('reviewsList').value = reviews.split('|').filter(Boolean).join('\n');
    } catch (err) {
      console.error('Error loading data:', err);
      alert('Error loading data. Please try again or contact support.');
    }
  }

  async function loadShipment() {
    const trackingNumber = document.getElementById('shipmentSelect').value;
    const preview = document.getElementById('signaturePreview');
    if (!trackingNumber) {
      // Clear form
      document.getElementById('trackingNumber').value = '';
      document.getElementById('shipmentAmount').value = '';
      document.getElementById('orderId').value = '';
      document.getElementById('estDeliveryDate').value = '';
      document.getElementById('paymentMode').value = '';
      document.getElementById('modeOfTransport').value = '';
      document.getElementById('typeOfShipment').value = '';
      document.getElementById('quantity').value = '';
      document.getElementById('shipmentContent').value = '';
      document.getElementById('shipmentOrigin').value = '';
      document.getElementById('shipmentDestination').value = '';
      document.getElementById('senderName').value = '';
      document.getElementById('senderAddress').value = '';
      document.getElementById('receiverName').value = '';
      document.getElementById('receiverAddress').value = '';
      document.getElementById('receiverMobile').value = '';
      document.getElementById('receiverLat').value = '';
      document.getElementById('receiverLng').value = '';
      document.getElementById('timeline').value = '';
      document.getElementById('officialStamp').value = '';
      document.getElementById('stampDate').value = '';
      preview.innerHTML = '<p>No stamp image selected.</p>';
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/shipments/${trackingNumber}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
      });
      if (!response.ok) throw new Error('Shipment not found');
      const shipment = await response.json();
      document.getElementById('trackingNumber').value = shipment.trackingNumber || '';
      document.getElementById('shipmentAmount').value = shipment.receipt?.amount || '';
      document.getElementById('orderId').value = shipment.orderId || '';
      document.getElementById('estDeliveryDate').value = shipment.estDeliveryDate || '';
      document.getElementById('paymentMode').value = shipment.paymentMode || '';
      document.getElementById('modeOfTransport').value = shipment.modeOfTransport || '';
      document.getElementById('typeOfShipment').value = shipment.typeOfShipment || '';
      document.getElementById('quantity').value = shipment.quantity || '';
      document.getElementById('shipmentContent').value = shipment.content || '';
      document.getElementById('shipmentOrigin').value = shipment.origin || '';
      document.getElementById('shipmentDestination').value = shipment.destination || '';
      document.getElementById('senderName').value = shipment.sender?.name || '';
      document.getElementById('senderAddress').value = shipment.sender?.address || '';
      document.getElementById('receiverName').value = shipment.receiver?.name || '';
      document.getElementById('receiverAddress').value = shipment.receiver?.address || '';
      document.getElementById('receiverMobile').value = shipment.receiver?.mobile || '';
      document.getElementById('receiverLat').value = shipment.receiver?.lat || '';
      document.getElementById('receiverLng').value = shipment.receiver?.lng || '';
      document.getElementById('timeline').value = JSON.stringify(shipment.timeline || [], null, 2);
      document.getElementById('stampDate').value = shipment.stampDate || '';
      preview.innerHTML = shipment.officialStamp
        ? `<img src="${shipment.officialStamp}" alt="Stamp Preview"><p>Current stamp image</p>`
        : '<p>No stamp image selected.</p>';
    } catch (err) {
      console.error('Error loading shipment:', err);
      alert('Error loading shipment data. Please try again.');
    }
  }

  function validateTimeline(timeline) {
    if (!Array.isArray(timeline)) return false;
    return timeline.every(event =>
      event.time && typeof event.time === 'string' &&
      event.description && typeof event.description === 'string' &&
      event.status && typeof event.status === 'string' &&
      typeof event.completed === 'boolean'
    );
  }

  async function saveNewsletter() {
    try {
      const emails = document.getElementById('newsletterList').value.split('\n').map(e => e.trim()).filter(Boolean);
      localStorage.setItem('newsletterEmails', emails.join(','));
      alert('Newsletter emails saved!');
    } catch (err) {
      console.error('Error saving newsletter:', err);
      alert('Error saving newsletter emails. Please try again.');
    }
  }

  async function saveReviews() {
    try {
      const reviews = document.getElementById('reviewsList').value.split('\n').map(e => e.trim()).filter(Boolean);
      localStorage.setItem('customerReviews', reviews.join('|'));
      alert('Customer reviews saved!');
    } catch (err) {
      console.error('Error saving reviews:', err);
      alert('Error saving customer reviews. Please try again.');
    }
  }

  async function saveShipment() {
    try {
      const trackingNumber = document.getElementById('trackingNumber').value.trim();
      if (!trackingNumber) throw new Error('Please select a shipment to edit.');
      let timeline;
      try {
        timeline = JSON.parse(document.getElementById('timeline').value.trim() || '[]');
        if (!validateTimeline(timeline)) {
          throw new Error('Invalid timeline format. Each event must have time, description, status, and completed fields.');
        }
      } catch (e) {
        throw new Error('Invalid timeline JSON: ' + e.message);
      }
      const stampInput = document.getElementById('officialStamp');
      let officialStamp = '';
      if (stampInput.files[0]) {
        const file = stampInput.files[0];
        if (!file.type.startsWith('image/')) throw new Error('Please upload a valid image file for the stamp.');
        if (file.size > 2 * 1024 * 1024) throw new Error('Stamp image size must be less than 2MB.');
        officialStamp = document.getElementById('signaturePreview').querySelector('img')?.src || '';
      } else {
        const response = await fetch(`${API_BASE_URL}/shipments/${trackingNumber}`);
        if (response.ok) {
          const existing = await response.json();
          officialStamp = existing.officialStamp || '';
        }
      }
      const stampDate = document.getElementById('stampDate').value.trim();
      if (!stampDate || isNaN(new Date(stampDate).getTime())) throw new Error('Invalid or missing stamp date.');
      const amount = parseFloat(document.getElementById('shipmentAmount').value);
      const lat = parseFloat(document.getElementById('receiverLat').value);
      const lng = parseFloat(document.getElementById('receiverLng').value);
      if (isNaN(amount)) throw new Error('Invalid shipment amount.');
      if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        throw new Error('Invalid receiver coordinates.');
      }
      const shipment = {
        trackingNumber,
        content: document.getElementById('shipmentContent').value.trim(),
        origin: document.getElementById('shipmentOrigin').value.trim(),
        destination: document.getElementById('shipmentDestination').value.trim(),
        orderId: document.getElementById('orderId').value.trim(),
        estDeliveryDate: document.getElementById('estDeliveryDate').value.trim(),
        modeOfTransport: document.getElementById('modeOfTransport').value.trim(),
        typeOfShipment: document.getElementById('typeOfShipment').value.trim(),
        quantity: document.getElementById('quantity').value.trim(),
        paymentMode: document.getElementById('paymentMode').value.trim(),
        sender: {
          name: document.getElementById('senderName').value.trim(),
          address: document.getElementById('senderAddress').value.trim(),
        },
        receiver: {
          name: document.getElementById('receiverName').value.trim(),
          address: document.getElementById('receiverAddress').value.trim(),
          mobile: document.getElementById('receiverMobile').value.trim(),
          lat,
          lng,
        },
        timeline,
        receipt: {
          companyName: COMPANY_NAME,
          amount,
        },
        officialStamp,
        stampDate,
      };

      if (!shipment.content || !shipment.origin || !shipment.destination || !shipment.sender.name ||
          !shipment.sender.address || !shipment.receiver.name || !shipment.receiver.address ||
          !shipment.receiver.mobile || isNaN(shipment.receiver.lat) || isNaN(shipment.receiver.lng) ||
          !shipment.orderId || !shipment.estDeliveryDate || !shipment.modeOfTransport ||
          !shipment.typeOfShipment || !shipment.quantity || !shipment.paymentMode ||
          isNaN(shipment.receipt.amount) || !shipment.stampDate) {
        throw new Error('All fields are required and must be valid.');
      }

      const response = await fetch(`${API_BASE_URL}/shipments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(shipment),
      });
      if (!response.ok) throw new Error('Failed to save shipment');
      const result = await response.json();
      alert('Shipment saved successfully! Changes will reflect on the public page receipt.');
      await loadData();
    } catch (e) {
      console.error('Error saving shipment:', e);
      alert(`Error: ${e.message}`);
    }
  }

  async function generateTrackingCode() {
    try {
      const letters = String.fromCharCode(...Array(3).fill().map(() => 65 + Math.floor(Math.random() * 26)));
      const numbers = Math.floor(100000000 + Math.random() * 900000000).toString();
      const newTracking = `${letters}-${numbers}`;
      let timeline;
      try {
        timeline = JSON.parse(document.getElementById('newTimeline').value.trim() || '[]');
        if (!validateTimeline(timeline)) {
          throw new Error('Invalid timeline format. Each event must have time, description, status, and completed fields.');
        }
      } catch (e) {
        throw new Error('Invalid timeline JSON: ' + e.message);
      }
      const stampInput = document.getElementById('newOfficialStamp');
      let officialStamp = '';
      if (stampInput.files[0]) {
        const file = stampInput.files[0];
        if (!file.type.startsWith('image/')) throw new Error('Please upload a valid image file for the stamp.');
        if (file.size > 2 * 1024 * 1024) throw new Error('Stamp image size must be less than 2MB.');
        officialStamp = document.getElementById('newSignaturePreview').querySelector('img')?.src || '';
      }
      const stampDate = document.getElementById('newStampDate').value.trim();
      if (!stampDate || isNaN(new Date(stampDate).getTime())) throw new Error('Invalid or missing stamp date.');
      const amount = parseFloat(document.getElementById('newShipmentAmount').value);
      const lat = parseFloat(document.getElementById('newReceiverLat').value);
      const lng = parseFloat(document.getElementById('newReceiverLng').value);
      if (isNaN(amount)) throw new Error('Invalid shipment amount.');
      if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        throw new Error('Invalid receiver coordinates.');
      }
      const shipment = {
        trackingNumber: newTracking,
        content: document.getElementById('newShipmentContent').value.trim(),
        origin: document.getElementById('newShipmentOrigin').value.trim(),
        destination: document.getElementById('newShipmentDestination').value.trim(),
        orderId: document.getElementById('newOrderId').value.trim(),
        estDeliveryDate: document.getElementById('newEstDeliveryDate').value.trim(),
        modeOfTransport: document.getElementById('newModeOfTransport').value.trim(),
        typeOfShipment: document.getElementById('newTypeOfShipment').value.trim(),
        quantity: document.getElementById('newQuantity').value.trim(),
        paymentMode: document.getElementById('newPaymentMode').value.trim(),
        sender: {
          name: document.getElementById('newSenderName').value.trim(),
          address: document.getElementById('newSenderAddress').value.trim(),
        },
        receiver: {
          name: document.getElementById('newReceiverName').value.trim(),
          address: document.getElementById('newReceiverAddress').value.trim(),
          mobile: document.getElementById('newReceiverMobile').value.trim(),
          lat,
          lng,
        },
        timeline,
        receipt: {
          companyName: COMPANY_NAME,
          amount,
        },
        officialStamp,
        stampDate,
      };

      if (!shipment.content || !shipment.origin || !shipment.destination || !shipment.sender.name ||
          !shipment.sender.address || !shipment.receiver.name || !shipment.receiver.address ||
          !shipment.receiver.mobile || isNaN(shipment.receiver.lat) || isNaN(shipment.receiver.lng) ||
          !shipment.orderId || !shipment.estDeliveryDate || !shipment.modeOfTransport ||
          !shipment.typeOfShipment || !shipment.quantity || !shipment.paymentMode ||
          isNaN(shipment.receipt.amount) || !shipment.stampDate) {
        throw new Error('All fields are required and must be valid.');
      }

      const response = await fetch(`${API_BASE_URL}/shipments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(shipment),
      });
      if (!response.ok) throw new Error('Failed to save shipment');
      const result = await response.json();
      document.getElementById('trackingNumber').value = newTracking;
      document.getElementById('shipmentAmount').value = shipment.receipt.amount;
      document.getElementById('orderId').value = shipment.orderId;
      document.getElementById('estDeliveryDate').value = shipment.estDeliveryDate;
      document.getElementById('paymentMode').value = shipment.paymentMode;
      document.getElementById('modeOfTransport').value = shipment.modeOfTransport;
      document.getElementById('typeOfShipment').value = shipment.typeOfShipment;
      document.getElementById('quantity').value = shipment.quantity;
      document.getElementById('shipmentContent').value = shipment.content;
      document.getElementById('shipmentOrigin').value = shipment.origin;
      document.getElementById('shipmentDestination').value = shipment.destination;
      document.getElementById('senderName').value = shipment.sender.name;
      document.getElementById('senderAddress').value = shipment.sender.address;
      document.getElementById('receiverName').value = shipment.receiver.name;
      document.getElementById('receiverAddress').value = shipment.receiver.address;
      document.getElementById('receiverMobile').value = shipment.receiver.mobile;
      document.getElementById('receiverLat').value = shipment.receiver.lat;
      document.getElementById('receiverLng').value = shipment.receiver.lng;
      document.getElementById('timeline').value = JSON.stringify(shipment.timeline, null, 2);
      document.getElementById('stampDate').value = shipment.stampDate;
      document.getElementById('signaturePreview').innerHTML = shipment.officialStamp
        ? `<img src="${shipment.officialStamp}" alt="Stamp Preview"><p>Current stamp image</p>`
        : '<p>No stamp image selected.</p>';
      document.getElementById('newTrackingNumber').value = newTracking;
      alert(`New tracking code generated: ${newTracking}. Details saved and loaded for editing.`);
      await loadData();
    } catch (e) {
      console.error('Error generating tracking code:', e);
      alert(`Error: ${e.message}`);
    }
  }
</script>