<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Admin Dashboard - Express Delivery</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; color: #000; margin: 0; padding: 0; }
    header { background: #1e90ff; color: white; padding: 15px; text-align: center; }
    .container { max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, textarea, select, button { margin: 5px 0; padding: 8px; width: 100%; border-radius: 3px; border: 1px solid #ccc; font-size: 14px; }
    input[readonly] { background: #e0e0e0; cursor: not-allowed; }
    button { background: #1e90ff; color: white; border: none; cursor: pointer; }
    button:hover { background: #1565c0; }
    h2, h3 { color: #1e90ff; margin-top: 0; }
    .section { margin-bottom: 30px; }
    label { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #1e90ff; color: white; }
    .shipment-form div { margin-bottom: 10px; }
    #generateTrackingCode { background: #4CAF50; color: white; }
    #signaturePreview img { max-width: 100px; height: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 3px; }
    #signaturePreview p { font-size: 12px; color: #555; }
  </style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
</header>

<div class="container">

  <!-- Login Section -->
  <div class="section" id="loginSection">
    <h2>Login</h2>
    <label>Email:</label>
    <input type="email" id="adminEmail" placeholder="Enter admin email" required>
    <label>Password:</label>
    <input type="password" id="adminPassword" placeholder="Enter password" required>
    <button onclick="login()">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <!-- Dashboard Section -->
  <div class="section" id="dashboardSection" style="display:none;">
    
    <h2>Edit Newsletter Subscribers</h2>
    <textarea id="newsletterList" rows="5" placeholder="Enter one email per line"></textarea>
    <button onclick="saveNewsletter()">Save Newsletter</button>

    <h2>Edit Customer Reviews</h2>
    <textarea id="reviewsList" rows="5" placeholder="Enter one review per line"></textarea>
    <button onclick="saveReviews()">Save Reviews</button>

    <h2>Upload Signature Stamp</h2>
    <div class="section">
      <label>Signature Stamp Image:</label>
      <input type="file" id="signatureStamp" accept="image/*">
      <div id="signaturePreview"></div>
      <button onclick="saveSignatureStamp()">Save Signature Stamp</button>
    </div>

    <h2>Generate New Tracking Code</h2>
    <div class="shipment-form">
      <input type="text" id="newTrackingNumber" placeholder="Tracking code will be generated" readonly>
      <div>
        <label>Amount ($):</label>
        <input type="number" id="newShipmentAmount" step="0.01" placeholder="Enter shipment amount" required>
      </div>
      <div>
        <label>Order ID:</label>
        <input type="text" id="newOrderId" placeholder="Enter order ID" required>
      </div>
      <div>
        <label>Est. Delivery Date:</label>
        <input type="date" id="newEstDeliveryDate" placeholder="Select estimated delivery date" required>
      </div>
      <div>
        <label>Payment Mode:</label>
        <input type="text" id="newPaymentMode" placeholder="Enter payment mode (e.g., Credit Card, Bank Transfer)" required>
      </div>
      <div>
        <label>Mode of Transport:</label>
        <input type="text" id="newModeOfTransport" placeholder="Enter mode of transport (e.g., Air, Sea)" required>
      </div>
      <div>
        <label>Type of Shipment:</label>
        <input type="text" id="newTypeOfShipment" placeholder="Enter shipment type (e.g., Express, Standard)" required>
      </div>
      <div>
        <label>Quantity:</label>
        <input type="text" id="newQuantity" placeholder="Enter quantity (e.g., 2 boxes)" required>
      </div>
      <div>
        <label>Official Stamp Date:</label>
        <input type="date" id="newOfficialStampDate" placeholder="Select official stamp date" required>
      </div>
      <div>
        <label>Content:</label>
        <input type="text" id="newShipmentContent" placeholder="Enter shipment content" required>
      </div>
      <div>
        <label>Origin:</label>
        <input type="text" id="newShipmentOrigin" placeholder="Enter origin area" required>
      </div>
      <div>
        <label>Destination:</label>
        <input type="text" id="newShipmentDestination" placeholder="Enter destination area" required>
      </div>
      <h3>Sender Details</h3>
      <div>
        <label>Name:</label>
        <input type="text" id="newSenderName" placeholder="Enter sender name" required>
      </div>
      <div>
        <label>Address:</label>
        <input type="text" id="newSenderAddress" placeholder="Enter sender address" required>
      </div>
      <h3>Receiver Details</h3>
      <div>
        <label>Name:</label>
        <input type="text" id="newReceiverName" placeholder="Enter receiver name" required>
      </div>
      <div>
        <label>Address:</label>
        <input type="text" id="newReceiverAddress" placeholder="Enter receiver address" required>
      </div>
      <div>
        <label>Mobile:</label>
        <input type="text" id="newReceiverMobile" placeholder="Enter receiver mobile" required>
      </div>
      <div>
        <label>Latitude (optional):</label>
        <input type="number" id="newReceiverLat" step="0.0001" placeholder="Enter receiver latitude">
      </div>
      <div>
        <label>Longitude (optional):</label>
        <input type="number" id="newReceiverLng" step="0.0001" placeholder="Enter receiver longitude">
      </div>
      <h3>Timeline</h3>
      <textarea id="newTimeline" rows="4" placeholder='Enter timeline events as JSON array (e.g., [{"time":"23 Sep 2025 07:30","description":"Item arrived","status":"ON HOLD","completed":true}])' required></textarea>
      <button id="generateTrackingCode" onclick="generateTrackingCode()">Generate Tracking Code</button>
      <p>Send the generated tracking code to the recipient for tracking on the public page.</p>
    </div>

    <h2>Edit Shipments</h2>
    <div class="shipment-form">
      <label>Select Shipment:</label>
      <select id="shipmentSelect" onchange="loadShipment()">
        <option value="">Select a shipment</option>
      </select>
      <input type="text" id="trackingNumber" placeholder="Tracking Number" readonly>
      <div>
        <label>Amount ($):</label>
        <input type="number" id="shipmentAmount" step="0.01" placeholder="Enter shipment amount">
      </div>
      <div>
        <label>Order ID:</label>
        <input type="text" id="orderId" placeholder="Enter order ID">
      </div>
      <div>
        <label>Est. Delivery Date:</label>
        <input type="date" id="estDeliveryDate" placeholder="Select estimated delivery date">
      </div>
      <div>
        <label>Payment Mode:</label>
        <input type="text" id="paymentMode" placeholder="Enter payment mode (e.g., Credit Card, Bank Transfer)">
      </div>
      <div>
        <label>Mode of Transport:</label>
        <input type="text" id="modeOfTransport" placeholder="Enter mode of transport">
      </div>
      <div>
        <label>Type of Shipment:</label>
        <input type="text" id="typeOfShipment" placeholder="Enter shipment type">
      </div>
      <div>
        <label>Quantity:</label>
        <input type="text" id="quantity" placeholder="Enter quantity">
      </div>
      <div>
        <label>Official Stamp Date:</label>
        <input type="date" id="officialStampDate" placeholder="Select official stamp date">
      </div>
      <div>
        <label>Content:</label>
        <input type="text" id="shipmentContent" placeholder="Enter shipment content">
      </div>
      <div>
        <label>Origin:</label>
        <input type="text" id="shipmentOrigin" placeholder="Enter origin area">
      </div>
      <div>
        <label>Destination:</label>
        <input type="text" id="shipmentDestination" placeholder="Enter destination area">
      </div>
      <h3>Sender Details</h3>
      <div>
        <label>Name:</label>
        <input type="text" id="senderName" placeholder="Enter sender name">
      </div>
      <div>
        <label>Address:</label>
        <input type="text" id="senderAddress" placeholder="Enter sender address">
      </div>
      <h3>Receiver Details</h3>
      <div>
        <label>Name:</label>
        <input type="text" id="receiverName" placeholder="Enter receiver name">
      </div>
      <div>
        <label>Address:</label>
        <input type="text" id="receiverAddress" placeholder="Enter receiver address">
      </div>
      <div>
        <label>Mobile:</label>
        <input type="text" id="receiverMobile" placeholder="Enter receiver mobile">
      </div>
      <div>
        <label>Latitude (optional):</label>
        <input type="number" id="receiverLat" step="0.0001" placeholder="Enter receiver latitude">
      </div>
      <div>
        <label>Longitude (optional):</label>
        <input type="number" id="receiverLng" step="0.0001" placeholder="Enter receiver longitude">
      </div>
      <h3>Timeline</h3>
      <textarea id="timeline" rows="4" placeholder='Enter timeline events as JSON array (e.g., [{"time":"23 Sep 2025 07:30","description":"Item arrived","status":"ON HOLD","completed":true}])'></textarea>
      <button onclick="saveShipment()">Save Shipment</button>
    </div>

    <button style="background:red;margin-top:15px;" onclick="logout()">Logout</button>
  </div>

</div>

<script>
// Admin Credentials
const ADMIN_EMAIL = "Expressdeliveryservice0016@gmail.com";
const ADMIN_PASSWORD = "Umuojima";
const COMPANY_NAME = "Express Delivery Service";

// IndexedDB Setup
const DB_NAME = 'ExpressDeliveryDB';
const DB_VERSION = 1;
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject('Failed to open IndexedDB');
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      db.createObjectStore('shipments', { keyPath: 'trackingNumber' });
      db.createObjectStore('newsletter', { keyPath: 'id' });
      db.createObjectStore('reviews', { keyPath: 'id' });
      db.createObjectStore('signature', { keyPath: 'id' });
    };
  });
}

// Request Persistent Storage
async function requestPersistentStorage() {
  if (navigator.storage && navigator.storage.persist) {
    try {
      const isPersisted = await navigator.storage.persisted();
      if (!isPersisted) {
        const result = await navigator.storage.persist();
        console.log('Persistent storage granted:', result);
      } else {
        console.log('Storage is already persistent');
      }
    } catch (e) {
      console.error('Error requesting persistent storage:', e);
    }
  }
}

// Migrate localStorage to IndexedDB
async function migrateLocalStorageToIndexedDB() {
  try {
    const shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
    const newsletter = localStorage.getItem('newsletterEmails') || '';
    const reviews = localStorage.getItem('customerReviews') || '';
    const signature = localStorage.getItem('signatureStamp') || '';

    const transaction = db.transaction(['shipments', 'newsletter', 'reviews', 'signature'], 'readwrite');
    const shipmentStore = transaction.objectStore('shipments');
    const newsletterStore = transaction.objectStore('newsletter');
    const reviewsStore = transaction.objectStore('reviews');
    const signatureStore = transaction.objectStore('signature');

    // Migrate shipments
    shipments.forEach(shipment => {
      shipmentStore.put(shipment);
    });

    // Migrate newsletter
    newsletterStore.put({ id: 'emails', value: newsletter });

    // Migrate reviews
    reviewsStore.put({ id: 'reviews', value: reviews });

    // Migrate signature
    if (signature) {
      signatureStore.put({ id: 'signatureStamp', value: signature });
    }

    // Clear localStorage after migration
    localStorage.removeItem('shipments');
    localStorage.removeItem('newsletterEmails');
    localStorage.removeItem('customerReviews');
    localStorage.removeItem('signatureStamp');
  } catch (e) {
    console.error('Migration failed:', e);
  }
}

// Login Function
async function login() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value.trim();
  if (email === ADMIN_EMAIL && pass === ADMIN_PASSWORD) {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
    await loadData();
  } else {
    document.getElementById('loginMessage').innerText = "Invalid email or password!";
  }
}

// Logout Function
function logout() {
  document.getElementById('loginSection').style.display = 'block';
  document.getElementById('dashboardSection').style.display = 'none';
  document.getElementById('adminEmail').value = '';
  document.getElementById('adminPassword').value = '';
  document.getElementById('loginMessage').innerText = '';
}

// Load existing data from IndexedDB
async function loadData() {
  try {
    await openDB();
    await requestPersistentStorage();

    // Migrate any existing localStorage data
    if (localStorage.getItem('shipments') || localStorage.getItem('newsletterEmails') ||
        localStorage.getItem('customerReviews') || localStorage.getItem('signatureStamp')) {
      await migrateLocalStorageToIndexedDB();
    }

    const transaction = db.transaction(['shipments', 'newsletter', 'reviews', 'signature'], 'readonly');
    const shipmentStore = transaction.objectStore('shipments');
    const newsletterStore = transaction.objectStore('newsletter');
    const reviewsStore = transaction.objectStore('reviews');
    const signatureStore = transaction.objectStore('signature');

    // Load shipments
    const shipmentsRequest = shipmentStore.getAll();
    shipmentsRequest.onsuccess = () => {
      const shipments = shipmentsRequest.result;
      const shipmentSelect = document.getElementById('shipmentSelect');
      shipmentSelect.innerHTML = '<option value="">Select a shipment</option>';
      shipments.forEach(shipment => {
        const option = document.createElement('option');
        option.value = shipment.trackingNumber;
        option.text = `${shipment.trackingNumber} - ${shipment.content}`;
        shipmentSelect.appendChild(option);
      });
    };

    // Load newsletter
    const newsletterRequest = newsletterStore.get('emails');
    newsletterRequest.onsuccess = () => {
      const result = newsletterRequest.result;
      document.getElementById('newsletterList').value = result ? result.value.split(',').join('\n') : '';
    };

    // Load reviews
    const reviewsRequest = reviewsStore.get('reviews');
    reviewsRequest.onsuccess = () => {
      const result = reviewsRequest.result;
      document.getElementById('reviewsList').value = result ? result.value.split('|').join('\n') : '';
    };

    // Load signature stamp
    const signatureRequest = signatureStore.get('signatureStamp');
    signatureRequest.onsuccess = () => {
      const result = signatureRequest.result;
      const preview = document.getElementById('signaturePreview');
      if (result && result.value) {
        preview.innerHTML = `<img src="${result.value}" alt="Signature Stamp"><p>Current signature stamp</p>`;
      } else {
        preview.innerHTML = `<p>No signature stamp uploaded</p>`;
      }
    };
  } catch (e) {
    console.error('Error loading data:', e);
    alert('Error loading data. Falling back to localStorage.');
    loadLocalStorageData(); // Fallback to localStorage
  }
}

// Fallback to localStorage
function loadLocalStorageData() {
  const newsletter = localStorage.getItem('newsletterEmails') || '';
  const reviews = localStorage.getItem('customerReviews') || '';
  const shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
  document.getElementById('newsletterList').value = newsletter.split(',').join('\n');
  document.getElementById('reviewsList').value = reviews.split('|').join('\n');

  const shipmentSelect = document.getElementById('shipmentSelect');
  shipmentSelect.innerHTML = '<option value="">Select a shipment</option>';
  shipments.forEach(shipment => {
    const option = document.createElement('option');
    option.value = shipment.trackingNumber;
    option.text = `${shipment.trackingNumber} - ${shipment.content}`;
    shipmentSelect.appendChild(option);
  });

  const signatureStamp = localStorage.getItem('signatureStamp');
  const preview = document.getElementById('signaturePreview');
  if (signatureStamp) {
    preview.innerHTML = `<img src="${signatureStamp}" alt="Signature Stamp"><p>Current signature stamp</p>`;
  } else {
    preview.innerHTML = `<p>No signature stamp uploaded</p>`;
  }
}

// Load selected shipment data
async function loadShipment() {
  const trackingNumber = document.getElementById('shipmentSelect').value;
  if (!trackingNumber) {
    // Clear form
    document.getElementById('trackingNumber').value = '';
    document.getElementById('shipmentAmount').value = '';
    document.getElementById('orderId').value = '';
    document.getElementById('estDeliveryDate').value = '';
    document.getElementById('modeOfTransport').value = '';
    document.getElementById('typeOfShipment').value = '';
    document.getElementById('quantity').value = '';
    document.getElementById('officialStampDate').value = '';
    document.getElementById('paymentMode').value = '';
    document.getElementById('shipmentContent').value = '';
    document.getElementById('shipmentOrigin').value = '';
    document.getElementById('shipmentDestination').value = '';
    document.getElementById('senderName').value = '';
    document.getElementById('senderAddress').value = '';
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverAddress').value = '';
    document.getElementById('receiverMobile').value = '';
    document.getElementById('receiverLat').value = '';
    document.getElementById('receiverLng').value = '';
    document.getElementById('timeline').value = '';
    return;
  }

  try {
    const transaction = db.transaction(['shipments'], 'readonly');
    const shipmentStore = transaction.objectStore('shipments');
    const request = shipmentStore.get(trackingNumber);
    request.onsuccess = () => {
      const shipment = request.result;
      if (shipment) {
        document.getElementById('trackingNumber').value = shipment.trackingNumber;
        document.getElementById('shipmentAmount').value = shipment.receipt.amount;
        document.getElementById('orderId').value = shipment.orderId;
        document.getElementById('estDeliveryDate').value = shipment.estDeliveryDate;
        document.getElementById('modeOfTransport').value = shipment.modeOfTransport;
        document.getElementById('typeOfShipment').value = shipment.typeOfShipment;
        document.getElementById('quantity').value = shipment.quantity;
        document.getElementById('officialStampDate').value = shipment.officialStampDate;
        document.getElementById('paymentMode').value = shipment.paymentMode;
        document.getElementById('shipmentContent').value = shipment.content;
        document.getElementById('shipmentOrigin').value = shipment.origin;
        document.getElementById('shipmentDestination').value = shipment.destination;
        document.getElementById('senderName').value = shipment.sender.name;
        document.getElementById('senderAddress').value = shipment.sender.address;
        document.getElementById('receiverName').value = shipment.receiver.name;
        document.getElementById('receiverAddress').value = shipment.receiver.address;
        document.getElementById('receiverMobile').value = shipment.receiver.mobile;
        document.getElementById('receiverLat').value = shipment.receiver.lat || '';
        document.getElementById('receiverLng').value = shipment.receiver.lng || '';
        document.getElementById('timeline').value = JSON.stringify(shipment.timeline, null, 2);
      }
    };
    request.onerror = () => {
      alert('Error loading shipment. Trying localStorage.');
      loadShipmentFromLocalStorage(trackingNumber);
    };
  } catch (e) {
    console.error('Error loading shipment:', e);
    loadShipmentFromLocalStorage(trackingNumber);
  }
}

// Fallback to localStorage for loading shipment
function loadShipmentFromLocalStorage(trackingNumber) {
  const shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
  const shipment = shipments.find(s => s.trackingNumber === trackingNumber);
  if (shipment) {
    document.getElementById('trackingNumber').value = shipment.trackingNumber;
    document.getElementById('shipmentAmount').value = shipment.receipt.amount;
    document.getElementById('orderId').value = shipment.orderId;
    document.getElementById('estDeliveryDate').value = shipment.estDeliveryDate;
    document.getElementById('modeOfTransport').value = shipment.modeOfTransport;
    document.getElementById('typeOfShipment').value = shipment.typeOfShipment;
    document.getElementById('quantity').value = shipment.quantity;
    document.getElementById('officialStampDate').value = shipment.officialStampDate;
    document.getElementById('paymentMode').value = shipment.paymentMode;
    document.getElementById('shipmentContent').value = shipment.content;
    document.getElementById('shipmentOrigin').value = shipment.origin;
    document.getElementById('shipmentDestination').value = shipment.destination;
    document.getElementById('senderName').value = shipment.sender.name;
    document.getElementById('senderAddress').value = shipment.sender.address;
    document.getElementById('receiverName').value = shipment.receiver.name;
    document.getElementById('receiverAddress').value = shipment.receiver.address;
    document.getElementById('receiverMobile').value = shipment.receiver.mobile;
    document.getElementById('receiverLat').value = shipment.receiver.lat || '';
    document.getElementById('receiverLng').value = shipment.receiver.lng || '';
    document.getElementById('timeline').value = JSON.stringify(shipment.timeline, null, 2);
  }
}

// Save Signature Stamp
async function saveSignatureStamp() {
  const fileInput = document.getElementById('signatureStamp');
  const preview = document.getElementById('signaturePreview');
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    if (file.type.startsWith('image/') && file.size <= 2 * 1024 * 1024) { // Limit to 2MB
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64Image = e.target.result;
        try {
          const transaction = db.transaction(['signature'], 'readwrite');
          const signatureStore = transaction.objectStore('signature');
          signatureStore.put({ id: 'signatureStamp', value: base64Image });
          preview.innerHTML = `<img src="${base64Image}" alt="Signature Stamp"><p>Current signature stamp</p>`;
          alert("Signature stamp saved successfully!");
        } catch (e) {
          console.error('Error saving signature to IndexedDB:', e);
          localStorage.setItem('signatureStamp', base64Image); // Fallback
          preview.innerHTML = `<img src="${base64Image}" alt="Signature Stamp"><p>Current signature stamp</p>`;
          alert("Signature stamp saved to localStorage (IndexedDB failed).");
        }
      };
      reader.readAsDataURL(file);
    } else {
      alert("Please upload a valid image file (max 2MB).");
    }
  } else {
    alert("Please select an image to upload.");
  }
}

// Save Newsletter
async function saveNewsletter() {
  try {
    const emails = document.getElementById('newsletterList').value.split('\n').map(e => e.trim()).filter(Boolean).join(',');
    const transaction = db.transaction(['newsletter'], 'readwrite');
    const newsletterStore = transaction.objectStore('newsletter');
    newsletterStore.put({ id: 'emails', value: emails });
    alert("Newsletter emails saved!");
  } catch (e) {
    console.error('Error saving newsletter:', e);
    localStorage.setItem('newsletterEmails', document.getElementById('newsletterList').value.split('\n').map(e => e.trim()).filter(Boolean).join(','));
    alert("Newsletter emails saved to localStorage (IndexedDB failed).");
  }
}

// Save Reviews
async function saveReviews() {
  try {
    const reviews = document.getElementById('reviewsList').value.split('\n').map(e => e.trim()).filter(Boolean).join('|');
    const transaction = db.transaction(['reviews'], 'readwrite');
    const reviewsStore = transaction.objectStore('reviews');
    reviewsStore.put({ id: 'reviews', value: reviews });
    alert("Customer reviews saved!");
  } catch (e) {
    console.error('Error saving reviews:', e);
    localStorage.setItem('customerReviews', document.getElementById('reviewsList').value.split('\n').map(e => e.trim()).filter(Boolean).join('|'));
    alert("Customer reviews saved to localStorage (IndexedDB failed).");
  }
}

// Save Shipment
async function saveShipment() {
  try {
    const trackingNumber = document.getElementById('trackingNumber').value.trim();
    if (!trackingNumber) {
      throw new Error("Please select a shipment to edit.");
    }
    const shipment = {
      trackingNumber: trackingNumber,
      content: document.getElementById('shipmentContent').value.trim(),
      origin: document.getElementById('shipmentOrigin').value.trim(),
      destination: document.getElementById('shipmentDestination').value.trim(),
      orderId: document.getElementById('orderId').value.trim(),
      estDeliveryDate: document.getElementById('estDeliveryDate').value.trim(),
      modeOfTransport: document.getElementById('modeOfTransport').value.trim(),
      typeOfShipment: document.getElementById('typeOfShipment').value.trim(),
      quantity: document.getElementById('quantity').value.trim(),
      paymentMode: document.getElementById('paymentMode').value.trim(),
      officialStampDate: document.getElementById('officialStampDate').value.trim(),
      officialStamp: (await getSignatureStamp()) || '',
      sender: {
        name: document.getElementById('senderName').value.trim(),
        address: document.getElementById('senderAddress').value.trim()
      },
      receiver: {
        name: document.getElementById('receiverName').value.trim(),
        address: document.getElementById('receiverAddress').value.trim(),
        mobile: document.getElementById('receiverMobile').value.trim(),
        lat: parseFloat(document.getElementById('receiverLat').value) || null,
        lng: parseFloat(document.getElementById('receiverLng').value) || null
      },
      timeline: JSON.parse(document.getElementById('timeline').value.trim() || '[]'),
      receipt: {
        companyName: COMPANY_NAME,
        amount: parseFloat(document.getElementById('shipmentAmount').value)
      }
    };

    // Validate required fields (latitude and longitude are optional)
    if (!shipment.content || !shipment.origin || !shipment.destination || !shipment.sender.name ||
        !shipment.sender.address || !shipment.receiver.name || !shipment.receiver.address ||
        !shipment.receiver.mobile || !shipment.orderId || !shipment.estDeliveryDate ||
        !shipment.modeOfTransport || !shipment.typeOfShipment || !shipment.quantity ||
        !shipment.officialStampDate || !shipment.paymentMode || isNaN(shipment.receipt.amount)) {
      throw new Error("All fields are required and must be valid (latitude and longitude are optional).");
    }

    const transaction = db.transaction(['shipments'], 'readwrite');
    const shipmentStore = transaction.objectStore('shipments');
    shipmentStore.put(shipment);
    alert("Shipment saved successfully! Changes will reflect on the public page receipt.");
    await loadData(); // Refresh dropdown
  } catch (e) {
    console.error('Error saving shipment:', e);
    alert(`Error: ${e.message}. Saving to localStorage as fallback.`);
    saveShipmentToLocalStorage();
  }
}

// Fallback to localStorage for saving shipment
function saveShipmentToLocalStorage() {
  try {
    const trackingNumber = document.getElementById('trackingNumber').value.trim();
    if (!trackingNumber) {
      throw new Error("Please select a shipment to edit.");
    }
    const shipment = {
      trackingNumber: trackingNumber,
      content: document.getElementById('shipmentContent').value.trim(),
      origin: document.getElementById('shipmentOrigin').value.trim(),
      destination: document.getElementById('shipmentDestination').value.trim(),
      orderId: document.getElementById('orderId').value.trim(),
      estDeliveryDate: document.getElementById('estDeliveryDate').value.trim(),
      modeOfTransport: document.getElementById('modeOfTransport').value.trim(),
      typeOfShipment: document.getElementById('typeOfShipment').value.trim(),
      quantity: document.getElementById('quantity').value.trim(),
      paymentMode: document.getElementById('paymentMode').value.trim(),
      officialStampDate: document.getElementById('officialStampDate').value.trim(),
      officialStamp: localStorage.getItem('signatureStamp') || '',
      sender: {
        name: document.getElementById('senderName').value.trim(),
        address: document.getElementById('senderAddress').value.trim()
      },
      receiver: {
        name: document.getElementById('receiverName').value.trim(),
        address: document.getElementById('receiverAddress').value.trim(),
        mobile: document.getElementById('receiverMobile').value.trim(),
        lat: parseFloat(document.getElementById('receiverLat').value) || null,
        lng: parseFloat(document.getElementById('receiverLng').value) || null
      },
      timeline: JSON.parse(document.getElementById('timeline').value.trim() || '[]'),
      receipt: {
        companyName: COMPANY_NAME,
        amount: parseFloat(document.getElementById('shipmentAmount').value)
      }
    };

    let shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
    const index = shipments.findIndex(s => s.trackingNumber === shipment.trackingNumber);
    if (index !== -1) {
      shipments[index] = shipment;
    } else {
      shipments.push(shipment);
    }
    localStorage.setItem('shipments', JSON.stringify(shipments));
    alert("Shipment saved to localStorage (IndexedDB failed).");
    loadLocalStorageData();
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

// Get Signature Stamp from IndexedDB
async function getSignatureStamp() {
  return new Promise((resolve) => {
    const transaction = db.transaction(['signature'], 'readonly');
    const signatureStore = transaction.objectStore('signature');
    const request = signatureStore.get('signatureStamp');
    request.onsuccess = () => resolve(request.result ? request.result.value : null);
    request.onerror = () => resolve(localStorage.getItem('signatureStamp') || null);
  });
}

// Generate New Tracking Code
async function generateTrackingCode() {
  try {
    const letters = String.fromCharCode(...Array(3).fill().map(() => 65 + Math.floor(Math.random() * 26)));
    const numbers = Math.floor(100000000 + Math.random() * 900000000).toString();
    const newTracking = `${letters}-${numbers}`;

    const shipment = {
      trackingNumber: newTracking,
      content: document.getElementById('newShipmentContent').value.trim(),
      origin: document.getElementById('newShipmentOrigin').value.trim(),
      destination: document.getElementById('newShipmentDestination').value.trim(),
      orderId: document.getElementById('newOrderId').value.trim(),
      estDeliveryDate: document.getElementById('newEstDeliveryDate').value.trim(),
      modeOfTransport: document.getElementById('newModeOfTransport').value.trim(),
      typeOfShipment: document.getElementById('newTypeOfShipment').value.trim(),
      quantity: document.getElementById('newQuantity').value.trim(),
      paymentMode: document.getElementById('newPaymentMode').value.trim(),
      officialStampDate: document.getElementById('newOfficialStampDate').value.trim(),
      officialStamp: (await getSignatureStamp()) || '',
      sender: {
        name: document.getElementById('newSenderName').value.trim(),
        address: document.getElementById('newSenderAddress').value.trim()
      },
      receiver: {
        name: document.getElementById('newReceiverName').value.trim(),
        address: document.getElementById('newReceiverAddress').value.trim(),
        mobile: document.getElementById('newReceiverMobile').value.trim(),
        lat: parseFloat(document.getElementById('newReceiverLat').value) || null,
        lng: parseFloat(document.getElementById('newReceiverLng').value) || null
      },
      timeline: JSON.parse(document.getElementById('newTimeline').value.trim() || '[]'),
      receipt: {
        companyName: COMPANY_NAME,
        amount: parseFloat(document.getElementById('newShipmentAmount').value)
      }
    };

    // Validate required fields (latitude and longitude are optional)
    if (!shipment.content || !shipment.origin || !shipment.destination || !shipment.sender.name ||
        !shipment.sender.address || !shipment.receiver.name || !shipment.receiver.address ||
        !shipment.receiver.mobile || !shipment.orderId || !shipment.estDeliveryDate ||
        !shipment.modeOfTransport || !shipment.typeOfShipment || !shipment.quantity ||
        !shipment.officialStampDate || !shipment.paymentMode || isNaN(shipment.receipt.amount)) {
      throw new Error("All fields are required and must be valid (latitude and longitude are optional).");
    }

    const transaction = db.transaction(['shipments'], 'readwrite');
    const shipmentStore = transaction.objectStore('shipments');
    const request = shipmentStore.get(newTracking);
    request.onsuccess = () => {
      if (request.result) {
        throw new Error("Tracking code already exists. Please try again.");
      }
      shipmentStore.put(shipment);
      document.getElementById('trackingNumber').value = newTracking;
      document.getElementById('shipmentAmount').value = shipment.receipt.amount;
      document.getElementById('orderId').value = shipment.orderId;
      document.getElementById('estDeliveryDate').value = shipment.estDeliveryDate;
      document.getElementById('modeOfTransport').value = shipment.modeOfTransport;
      document.getElementById('typeOfShipment').value = shipment.typeOfShipment;
      document.getElementById('quantity').value = shipment.quantity;
      document.getElementById('officialStampDate').value = shipment.officialStampDate;
      document.getElementById('paymentMode').value = shipment.paymentMode;
      document.getElementById('shipmentContent').value = shipment.content;
      document.getElementById('shipmentOrigin').value = shipment.origin;
      document.getElementById('shipmentDestination').value = shipment.destination;
      document.getElementById('senderName').value = shipment.sender.name;
      document.getElementById('senderAddress').value = shipment.sender.address;
      document.getElementById('receiverName').value = shipment.receiver.name;
      document.getElementById('receiverAddress').value = shipment.receiver.address;
      document.getElementById('receiverMobile').value = shipment.receiver.mobile;
      document.getElementById('receiverLat').value = shipment.receiver.lat || '';
      document.getElementById('receiverLng').value = shipment.receiver.lng || '';
      document.getElementById('timeline').value = JSON.stringify(shipment.timeline, null, 2);
      document.getElementById('newTrackingNumber').value = newTracking;
      alert(`New tracking code generated: ${newTracking}. Details saved and loaded for editing. Changes will reflect on the public page receipt.`);
      loadData();
    };
    request.onerror = () => {
      alert('Error checking tracking code. Saving to localStorage.');
      saveShipmentToLocalStorage(newTracking, shipment);
    };
  } catch (e) {
    console.error('Error generating tracking code:', e);
    alert(`Error: ${e.message}. Trying localStorage.`);
    generateTrackingCodeToLocalStorage();
  }
}

// Fallback to localStorage for generating tracking code
function generateTrackingCodeToLocalStorage() {
  try {
    const letters = String.fromCharCode(...Array(3).fill().map(() => 65 + Math.floor(Math.random() * 26)));
    const numbers = Math.floor(100000000 + Math.random() * 900000000).toString();
    const newTracking = `${letters}-${numbers}`;
    const shipment = {
      trackingNumber: newTracking,
      content: document.getElementById('newShipmentContent').value.trim(),
      origin: document.getElementById('newShipmentOrigin').value.trim(),
      destination: document.getElementById('newShipmentDestination').value.trim(),
      orderId: document.getElementById('newOrderId').value.trim(),
      estDeliveryDate: document.getElementById('newEstDeliveryDate').value.trim(),
      modeOfTransport: document.getElementById('newModeOfTransport').value.trim(),
      typeOfShipment: document.getElementById('newTypeOfShipment').value.trim(),
      quantity: document.getElementById('newQuantity').value.trim(),
      paymentMode: document.getElementById('newPaymentMode').value.trim(),
      officialStampDate: document.getElementById('newOfficialStampDate').value.trim(),
      officialStamp: localStorage.getItem('signatureStamp') || '',
      sender: {
        name: document.getElementById('newSenderName').value.trim(),
        address: document.getElementById('newSenderAddress').value.trim()
      },
      receiver: {
        name: document.getElementById('newReceiverName').value.trim(),
        address: document.getElementById('newReceiverAddress').value.trim(),
        mobile: document.getElementById('newReceiverMobile').value.trim(),
        lat: parseFloat(document.getElementById('newReceiverLat').value) || null,
        lng: parseFloat(document.getElementById('newReceiverLng').value) || null
      },
      timeline: JSON.parse(document.getElementById('newTimeline').value.trim() || '[]'),
      receipt: {
        companyName: COMPANY_NAME,
        amount: parseFloat(document.getElementById('newShipmentAmount').value)
      }
    };

    let shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
    if (shipments.some(s => s.trackingNumber === newTracking)) {
      throw new Error("Tracking code already exists. Please try again.");
    }
    shipments.push(shipment);
    localStorage.setItem('shipments', JSON.stringify(shipments));

    document.getElementById('trackingNumber').value = newTracking;
    document.getElementById('shipmentAmount').value = shipment.receipt.amount;
    document.getElementById('orderId').value = shipment.orderId;
    document.getElementById('estDeliveryDate').value = shipment.estDeliveryDate;
    document.getElementById('modeOfTransport').value = shipment.modeOfTransport;
    document.getElementById('typeOfShipment').value = shipment.typeOfShipment;
    document.getElementById('quantity').value = shipment.quantity;
    document.getElementById('officialStampDate').value = shipment.officialStampDate;
    document.getElementById('paymentMode').value = shipment.paymentMode;
    document.getElementById('shipmentContent').value = shipment.content;
    document.getElementById('shipmentOrigin').value = shipment.origin;
    document.getElementById('shipmentDestination').value = shipment.destination;
    document.getElementById('senderName').value = shipment.sender.name;
    document.getElementById('senderAddress').value = shipment.sender.address;
    document.getElementById('receiverName').value = shipment.receiver.name;
    document.getElementById('receiverAddress').value = shipment.receiver.address;
    document.getElementById('receiverMobile').value = shipment.receiver.mobile;
    document.getElementById('receiverLat').value = shipment.receiver.lat || '';
    document.getElementById('receiverLng').value = shipment.receiver.lng || '';
    document.getElementById('timeline').value = JSON.stringify(shipment.timeline, null, 2);
    document.getElementById('newTrackingNumber').value = newTracking;
    alert(`New tracking code generated: ${newTracking}. Details saved to localStorage (IndexedDB failed).`);
    loadLocalStorageData();
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    await openDB();
    await requestPersistentStorage();
    await loadData();
  } catch (e) {
    console.error('Error initializing:', e);
    loadLocalStorageData();
  }
});
</script>

</body>
</html>
